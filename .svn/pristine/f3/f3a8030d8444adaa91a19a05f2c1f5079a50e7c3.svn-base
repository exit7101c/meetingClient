<template>
  <ion-page>
    <ion-header>
      <ion-toolbar class="join-toolbar">
        <ion-buttons slot="start">
          <BackButton @event="goRouter" :custom="true" />
        </ion-buttons>
        <ion-title>í”„ë¡œí•„ ìˆ˜ì •</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
      <div class="row-box">
        <ion-row>
          <ion-col size="4">
            <AddPhotoButton
              @click="addPhoto('add1')"
              :name="cdnNm1"
              :required="true"
            />
          </ion-col>
          <ion-col size="4">
            <AddPhotoButton
              @click="addPhoto('add2')"
              :name="cdnNm2"
              :required="true"
            />
          </ion-col>
          <ion-col size="4">
            <AddPhotoButton
              @click="addPhoto('add3')"
              @photoDelete="deletePhoto('add3')"
              :name="cdnNm3"
              :delPhoto="true"
            />
          </ion-col>
          <ion-col size="4">
            <AddPhotoButton
              @click="addPhoto('add4')"
              @photoDelete="deletePhoto('add4')"
              :name="cdnNm4"
              :delPhoto="true"
            />
          </ion-col>
          <ion-col size="4">
            <AddPhotoButton
              @click="addPhoto('add5')"
              @photoDelete="deletePhoto('add5')"
              :name="cdnNm5"
              :delPhoto="true"
            />
          </ion-col>
          <ion-col size="4">
            <AddPhotoButton
              @click="addPhoto('add6')"
              @photoDelete="deletePhoto('add6')"
              :name="cdnNm6"
              :delPhoto="true"
            />
          </ion-col>
        </ion-row>

        <input
          type="file"
          @change="onFileChange"
          ref="photo"
          class="is-blind"
        />
      </div>

      <div class="row-box">
        <ion-card padding="sm" shadow="light">
          <ion-item class="text-md" lines="none">
            <ion-text class="sub-text01">ì´ˆì´ìŠ¤ì— ê³µê°œí•˜ê¸°</ion-text>
            <ion-toggle
              slot="end"
              mode="ios"
              :checked="choiceRegisterChecked"
              :disabled="choiceYn == 'N'"
              @click="choiceRegister()"
            >
            </ion-toggle>
          </ion-item>
          <ion-card-content class="text-md" style="color: #fff" lines="none">
            ì´ ê¸°ëŠ¥ì„ ë„ë©´ ë‚´ í”„ë¡œí•„ì´ ì´ˆì´ìŠ¤ì— ë…¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br />
            í”„ë¡œí•„ ê³µê°œê°€ ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ë¶„ë“¤ì€ ê¸°ëŠ¥ì„ êº¼ì„œ ì•ˆì „í•˜ê²Œ ì´ìš©í•´ë´ìš”:)
          </ion-card-content>
        </ion-card>
      </div>

      <!-- ë‚´ì†Œê°œ -->
      <div class="row-box">
        <MyPageNavButtonItem
          content
          title="ë‚´ ì†Œê°œ ğŸ™‚"
          @click="editBtn('shortWord')"
        >
          <ion-text color="light" class="text-md">
            {{ profileList.shortWord }}
          </ion-text>
        </MyPageNavButtonItem>
      </div>
      <!-- ë‚´ ê¸°ë³¸ì •ë³´ -->
      <div class="row-box">
        <MyPageNavButtonItem
          content
          title="ë‚´ ê¸°ë³¸ì •ë³´ âœ‹"
          @click="editBtn('info')"
        >
          <ion-row>
            <ion-col size="2">
              <ion-text color="secondary" class="text-md">ë‚˜ì´</ion-text>
            </ion-col>
            <ion-col size="4">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.age }}
              </ion-text>
            </ion-col>

            <ion-col size="2">
              <ion-text color="secondary" class="text-md">ê±°ì£¼</ion-text>
            </ion-col>
            <ion-col size="4">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.addrLiveSum }}
              </ion-text>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="2">
              <ion-text color="secondary" class="text-md">í‚¤</ion-text>
            </ion-col>
            <ion-col size="4">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.tall }}cm
              </ion-text>
            </ion-col>
            <ion-col size="2">
              <ion-text color="secondary" class="text-md">ëª¸ë¬´ê²Œ</ion-text>
            </ion-col>
            <ion-col size="4">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.weight }}kg
              </ion-text>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="2">
              <ion-text color="secondary" class="text-md">ìŒì£¼</ion-text>
            </ion-col>
            <ion-col size="4">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.drinkNm }}
              </ion-text>
            </ion-col>
            <ion-col size="2">
              <ion-text color="secondary" class="text-md">í¡ì—°</ion-text>
            </ion-col>
            <ion-col size="4">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.smokeNm }}
              </ion-text>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="2">
              <ion-text color="secondary" class="text-md">ì•„ì´ì½˜</ion-text>
            </ion-col>
            <ion-col size="4">
              <ion-text color="light" class="text-md text-bold">
                {{ profileList.iconNm }}
              </ion-text>
            </ion-col>
          </ion-row>
        </MyPageNavButtonItem>
      </div>
      <div class="row-box">
        <MyPageNavButtonItem
          content
          title="ë‚´ ì§€ì—­ ğŸ‘Ÿ"
          @click="editBtn('location')"
        >
          <ion-text color="light" class="text-md">
            {{ profileList.addrLiveSum }}
          </ion-text>
        </MyPageNavButtonItem>
      </div>
      <!-- ë‚´í‚¤ì›Œë“œ -->
      <div class="row-box">
        <MyPageNavButtonItem
          content
          title="ë‚˜ì˜ í‚¤ì›Œë“œ #"
          @click="editBtn('keyword')"
        >
          <ion-row>
            <ion-col size="4">
              <ion-text color="secondary" class="text-md">MBTI</ion-text>
            </ion-col>
            <ion-col size="8">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.mbtiNm }}
              </ion-text>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="4">
              <ion-text color="secondary" class="text-md">ì·¨ë¯¸</ion-text>
            </ion-col>
            <ion-col size="8">
              <ion-text color="light" class="text-md text-bold"
              >{{ profileList.hobbyNm }}
              </ion-text>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="4">
              <ion-text color="secondary" class="text-md"
              >ì œ ì´ìƒí˜•ì€
              </ion-text>
            </ion-col>
            <ion-col size="8">
              <ion-text color="light" class="text-md text-bold">
                {{ profileList.idealLookNm }}, {{ profileList.idealFormNm }},
                {{ profileList.idealCharacterNm }}
              </ion-text>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="4">
              <ion-text color="secondary" class="text-md"
              >ìš”ì¦˜ ë¹ ì§„ ë…¸ë˜
              </ion-text>
            </ion-col>
            <ion-col size="8">
              <ion-text color="light" class="text-md text-bold">
                {{ profileList.likeSinger }}, {{ profileList.likeMusic }}
              </ion-text>
            </ion-col>
          </ion-row>
        </MyPageNavButtonItem>
      </div>
      <div class="row-box">
        <MyPageNavButtonItem
          content
          title="ë‚˜ì˜ ë±ƒì§€"
          @click="editBtn('badge')"
        >
          <ion-row>
            <ion-col size="4">
              <ion-text color="secondary" class="text-md">íšë“í•œ ë±ƒì§€ ìˆ˜</ion-text>
            </ion-col>
            <ion-col size="8">
              <ion-text color="primary" class="text-md text-bold"
              >{{ totalCnt }} ê±´
              </ion-text>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="4">
              <ion-text color="secondary" class="text-md">ë°˜ë ¤ ë±ƒì§€ ìˆ˜</ion-text>
            </ion-col>
            <ion-col size="8">
              <ion-text color="danger" class="text-md text-bold"
              >{{ rejectCnt }} ê±´
              </ion-text>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="4">
              <ion-text color="secondary" class="text-md">ì¸ì¦ ëŒ€ê¸° ë±ƒì§€ ìˆ˜</ion-text>
            </ion-col>
            <ion-col size="8">
              <ion-text color="light" class="text-md text-bold"
              >{{ waitCnt }} ê±´
              </ion-text>
            </ion-col>
          </ion-row>
        </MyPageNavButtonItem>
      </div>
    </ion-content>
  </ion-page>
</template>

<script>
import { getData, profileMap, setFile } from "@/assets/js/common";
import MyPageNavButtonItem from "@/components/MyPage/MyPageNavButtonItem.vue";
import AddPhotoButton from "@/components/AddPhotoButton.vue";
import { Camera, CameraResultType, CameraSource } from "@capacitor/camera";

export default {
  name: "Profile",
  inject: ["alertController", "loadingController"],
  components: {
    MyPageNavButtonItem,
    AddPhotoButton
  },
  data() {
    return {
      email: "",
      phon: "",
      birth: "",
      sex: "",
      sex_str: "",
      name: "",

      /** í”„ë¡œí•„ ì‚¬ì§„ **/
      Attachfiles: [],
      mainFileId: "",

      cdnNm1: null,
      cdnNm2: null,
      cdnNm3: null,
      cdnNm4: null,
      cdnNm5: null,
      cdnNm6: null,
      add1imgFileId: null,
      add2imgFileId: null,
      add3imgFileId: null,
      add4imgFileId: null,
      add5imgFileId: null,
      add6imgFileId: null,
      /** í”„ë¡œí•„ ì‚¬ì§„ **/
      cardType: null,

      profileList: [],

      nick: "",
      age: "",

      shortWord: "",
      profile: "",
      keyword: "",
      interview: "",

      loading: null,

      choiceOpenYn: "",
      choiceRegisterChecked: true,

      choiceYn: "N",

      myBadgeCheck: false,
      totalCnt: 0,
      rejectCnt: 0,
      waitCnt: 0
    };
  },
  computed: {},
  ionViewWillEnter() {
    // ì§„ì…í•  ë•Œ í˜¸ì¶œ
    this.getSettingUserInfo();

    this.checkChoiceYn();
    this.checkBadge();
  },
  ionViewDidLeave() {
    // ë– ë‚  ë•Œ í˜¸ì¶œ
  },
  mounted() {
    // this.selectOne();
  },
  methods: {
    checkBadge() {
      getData({
        url: "/getBadgeSituation",
        param: {},
        then: (data) => {
          if (data.totalCnt > 0) {
            this.myBadgeCheck = true;
            this.totalCnt = data.totalCnt;
            this.rejectCnt = data.rejectCnt;
            this.waitCnt = data.waitCnt;
          } else {
            this.myBadgeCheck = false;
          }
        }
      });
    },
    checkChoiceYn() {
      getData({
        url: "/choiceYnCheck",
        param: {},
        then: (data) => {
          this.choiceYn = data.choiceYn;
        }
      });
    },
    goRouter() {
      if (profileMap.pageType === "profileEdit") {
        this.$router.push("/mypage");
      } else {
        this.$router.go(-1);
      }
    },
    getResult() {
      let resultObj = {};

      resultObj.photo1 = this.add1imgFileId;
      resultObj.photo2 = this.add2imgFileId ? this.add2imgFileId : null;
      resultObj.photo3 = this.add3imgFileId ? this.add3imgFileId : null;
      resultObj.photo4 = this.add4imgFileId ? this.add4imgFileId : null;
      resultObj.photo5 = this.add5imgFileId ? this.add5imgFileId : null;
      resultObj.photo6 = this.add6imgFileId ? this.add6imgFileId : null;

      return resultObj;
    },

    choiceRegister() {
      this.showLoading();

      this.choiceOpenYn = this.choiceOpenYn == "Y" ? "N" : "Y";

      getData({
        url: "/choiceRegister",
        param: {
          choiceOpenYn: this.choiceOpenYn
        },
        then: (data) => {
          this.getSettingUserInfo();
          this.loading.dismiss();
        }
      });
    },

    editBtn(e) {
      switch (e) {
        case "shortWord":
          this.$router.push("/profileShortWord");
          break;
        case "profile":
          this.$router.push("/profileProfile");
          break;
        case "location":
          this.$router.push("/profileLocation");
          break;
        case "job":
          this.$router.push("/profileJob");
          break;
        case "school":
          this.$router.push("/profileEducation");
          break;
        case "keyword":
          this.$router.push("/profileKeyword");
          break;
        case "info":
          this.$router.push("/profileInfo");
          break;
        case "interview":
          this.$router.push("/profileInterview");
          break;
        case "badge":
          if (this.myBadgeCheck) {
            this.$router.push("/myBadge");
          } else {
            this.warningConfirm("ë‚´ ë±ƒì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë±ƒì§€ ì¸ì¦ì‹ ì²­ í™”ë©´ìœ¼ë¡œ ì´ë™í• ê¹Œìš”?", () => {
              this.$router.push("/certification");
            });
          }
          break;
      }
    },

    /** ë°›ì€ ë¦¬ìŠ¤íŠ¸ **/
    getSettingUserInfo() {
      getData({
        url: "/getSettingUserInfo",
        param: {},
        target: this,
        then: (data) => {
          this.profileList = data;

          /** ì´ë¯¸ì§€ **/
          this.add1imgFileId = data.photo1;
          this.add2imgFileId = data.photo2;
          this.add3imgFileId = data.photo3;
          this.add4imgFileId = data.photo4;
          this.add5imgFileId = data.photo5;
          this.add6imgFileId = data.photo6;
          this.cdnNm1 = data.cdnNm1;
          this.cdnNm2 = data.cdnNm2;
          this.cdnNm3 = data.cdnNm3;
          this.cdnNm4 = data.cdnNm4;
          this.cdnNm5 = data.cdnNm5;
          this.cdnNm6 = data.cdnNm6;

          this.choiceOpenYn =
            data.choiceOpenYn != null ? data.choiceOpenYn : "Y";
          if (this.choiceOpenYn == "Y") {
            this.choiceRegisterChecked = true;
          } else {
            this.choiceRegisterChecked = false;
          }
        }
      });
    },

    getUpdateImg() {
      getData({
        url: "/updateProfilePic",
        param: this.getResult(),
        target: this,
        then: (data) => {
          if (data.isUpdate === true) {
            this.loading.dismiss();
            this.warningAlert("ì‚¬ì§„ë“±ë¡ì„±ê³µ");
            this.getSettingUserInfo();
          }
        }
      });
    },

    deletePhoto(state) {
      this.showLoading();
      getData({
        url: "/deleteProfilePic",
        param: { deletePhoto: state },
        target: this,
        then: (data) => {
          this.loading.dismiss();
          if (data.successYn === "Y") {
            this.warningAlert(data.message);
            this.getSettingUserInfo();
          } else {
            this.warningAlert(data.message);
          }
        }
      });
    },

    getDeleteImg() {
      // getData({
      //   url: "/deleteProfilePic",
      //   param: {deletePhoto: },
      //   target: this,
      //   then: (data) => {
      //     if (data.isUpdate === true) {
      //       this.loading.dismiss();
      //       this.warningAlert("ì‚¬ì§„ë“±ë¡ì„±ê³µ");
      //       this.getSettingUserInfo();
      //     }
      //   }
      // });
    },

    /** ì‚¬ì§„ ì—…ë¡œë“œ **/
    addPhoto(state) {
      switch (state) {
        case "add1":
          this.uploadType = "add1";
          break;
        case "add2":
          this.uploadType = "add2";
          break;
        case "add3":
          this.uploadType = "add3";
          break;
        case "add4":
          this.uploadType = "add4";
          break;
        case "add5":
          this.uploadType = "add5";
          break;
        case "add6":
          this.uploadType = "add6";
          break;
      }

      /** ì‚¬ì§„ì²© í˜¸ì¶œ & íŒŒì¼ê°ì²´ ë³€í™˜ **/
      Camera.getPhoto({
        allowEditing: false, //ì‚¬ì§„ìˆ˜ì •ì—¬ë¶€ (ì•ˆë“œë¡œì´ë“œë§Œ ê°€ëŠ¥, IOSëŠ” ì¹´ë©”ë¼ ì´¬ì˜ì‹œë§Œ ìˆ˜ì •)
        source: CameraSource.Photos, //ì‚¬ì§„ì²¨, ì´¬ì˜, ë“± ì„¤ì •
        resultType: CameraResultType.Uri //ì‚¬ì§„ result Type
      }).then(async (photo) => {
        let blob = await fetch(photo.webPath).then((r) => r.blob());
        const file = new File([blob], "fileName." + photo.format, {
          lastModified: new Date(),
          type: blob.type
        });

        this.Attachfiles.push(file);
        this.$nextTick(() => {
          this.insertFile(this.uploadType);
        });
      });
      /** //ì‚¬ì§„ì²© í˜¸ì¶œ & íŒŒì¼ê°ì²´ ë³€í™˜ **/

      // this.$refs.photo.click();
    },

    onFileChange: function onFileChange(e) {
      const files = e.target.files || e.dataTransfer.files;
      if (!files.length) {
        return;
      }

      const allowedTypes = [
        "image/jpg",
        "image/jpeg",
        "image/png",
        "image/gif"
      ]; // í—ˆìš©í•  ì´ë¯¸ì§€ íŒŒì¼ í™•ì¥ì ëª©ë¡
      const file = files[0];
      if (!allowedTypes.includes(file.type)) {
        // ì„ íƒí•œ íŒŒì¼ì´ í—ˆìš©ëœ ì´ë¯¸ì§€ íŒŒì¼ í™•ì¥ì ëª©ë¡ì— í¬í•¨ë˜ì§€ ì•ŠëŠ” ê²½ìš°
        this.warningAlert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•´ìš”"); // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë©”ì‹œì§€ ì¶œë ¥
        return;
      }
      this.Attachfiles.push(files[0]);

      this.$nextTick(() => {
        this.insertFile(this.uploadType);
      });
    },
    /** ì‚¬ì§„ ì €ì¥ **/
    insertFile(e) {
      this.showLoading();
      //ì´ë¯¸ì§€ í™•ì¥ì ìš©ëŸ‰ ì²´í¬
      setFile({
        url: "/setImage",
        param: {},
        file: this.Attachfiles,
        then: (data) => {
          //ì´ˆê¸°í™”
          this.Attachfiles = [];
          /** ìƒíƒœê°’ í™•ì¸í›„ í•´ë‹¹ ì‚¬ì§„ ë³€ê²½ **/
          switch (e) {
            case "add1":
              this.add1imgFileId = data.fileId;
              this.cdnNm1 = data.cdnNm;
              break;
            case "add2":
              this.add2imgFileId = data.fileId;
              this.cdnNm2 = data.cdnNm;
              break;
            case "add3":
              this.add3imgFileId = data.fileId;
              this.cdnNm3 = data.cdnNm;
              break;
            case "add4":
              this.add4imgFileId = data.fileId;
              this.cdnNm4 = data.cdnNm;
              break;
            case "add5":
              this.add5imgFileId = data.fileId;
              this.cdnNm5 = data.cdnNm;
              break;
            case "add6":
              this.add6imgFileId = data.fileId;
              this.cdnNm6 = data.cdnNm;
              break;
          }

          this.getUpdateImg();
        }
      });
    },
    /** ë¡œë”© **/
    async showLoading() {
      this.loading = await this.loadingController.create({
        message: "Loading...",
        duration: 0
      });
      await this.loading.present();
    },

    /** Alertì°½ **/
    async warningAlert(message) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: ["OK"]
      });
      return alert.present();
    },
    async warningConfirm(message, callBack) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: [
          {
            text: "ì•„ë‹ˆìš”",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
            }
          },
          {
            text: "ë„¤",
            handler: () => {
              callBack();
            }
          }
        ]
      });
      return alert.present();
    }
  }
};
</script>

<style lang="scss" scoped>
ion-card {
  margin: 5px;
  border-radius: var(--ion-border-radius);
  border: 1px solid var(--ion-border-color);
  box-shadow: none;

  + ion-card {
    margin-top: 10px;
  }

  ion-item {
    padding: 5px;
    --detail-icon-color: white;
    --detail-icon-opacity: 1;
    --detail-icon-font-size: 20px;

    &.has-content {
      + ion-card-content {
        padding-top: 0;
      }
    }

    ion-card-content {
      padding: 1rem;
    }
  }
}
</style>
