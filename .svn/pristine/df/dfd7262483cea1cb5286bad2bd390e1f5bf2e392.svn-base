<template>
  <ion-page>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <BackButton />
        </ion-buttons>
        <ion-title> ë‚˜ì˜ í˜¸ê°ëª©ë¡</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content ref="myLikeContent">
      <div class="sticky-top segment-round">
        <ion-segment
          v-model="currentTab"
          mode="md"
          :scrollable="true"
          @ionChange="changeSegment"
          class="segment-round-button"
        >
          <ion-segment-button value="my">ë‚´ê°€ ë°›ì€ ì¢‹ì•„ìš”({{ receiveLikeCnt }}ëª…)</ion-segment-button>
          <ion-segment-button value="send">ë‚´ê°€ ë³´ë‚¸ ì¢‹ì•„ìš”</ion-segment-button>
        </ion-segment>
      </div>
      <div class="mt-2 pt-2">
        <!-- ì•„ì´í…œ êµ¬ë§¤í•˜ê¸° ì „ -->
        <MyLikeTopNotice
          v-if="subscribeInfo.isActionInfinite != 'Y'"
          :icon="iconSample"
          @click.stop="profileModalBtn('confirmReceiveLike')"
        >
          <template #content>
            <ion-text color="light" class="text-lg">
              {{ receiveLikeCnt }}ëª…ì´ ë‚˜ë¥¼ LIKE í–ˆì–´ìš”!
            </ion-text>
            <br />
            <ion-text color="light" class="text-sm">
              ë„¤ì´ë¹„ PLUS ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ê³  ëˆ„êµ°ì§€ í™•ì¸í•´ ë³´ì„¸ìš”
            </ion-text>
          </template>
        </MyLikeTopNotice>
        <!-- ì•„ì´í…œ êµ¬ë§¤í•˜ê¸° í›„ -->
        <MyLikeTopNotice
          v-else
          :icon="iconSample"
          :active="true"
          @click.stop="profileModalBtn('confirmReceiveLike')"
        >
          <template #content>
            <ion-text color="light" class="text-lg"
            >ì§€ê¸ˆ ë°›ì€ ì¢‹ì•„ìš”ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”!
              <!--            >ì§€ê¸ˆ ìŠˆí¼ë¼ì´í¬ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”!-->
            </ion-text>
            <br />
            <ion-text color="light" class="text-sm">
              ìµëª…ì±„íŒ…ì„ í†µí•´ ìƒëŒ€ë°©ì„ ì•Œì•„ê°€ë³´ì„¸ìš”
              <!-- {{ this.subscribeInfo.startDate }}~{{
                this.subscribeInfo.endDate
              }}
              ì¼ê¹Œì§€ í™•ì¸ ê°€ëŠ¥í•´ìš” -->
            </ion-text>
          </template>
        </MyLikeTopNotice>
      </div>
      <div class="ion-padding">
        <!-- ë³¸ë¬¸ -->
        <!--   ë‚´ê°€ ë°›ì€ ì¢‹ì•„ìš”    -->
        <template v-if="currentTab === 'my'">
          <!-- Refresh -->
          <ion-refresher slot="fixed" @ionRefresh="doRefresh($event, 'my')">
            <ion-refresher-content
              refreshing-spinner="circles"
              :pulling-icon="chevronDownCircleOutline"
            ></ion-refresher-content>
          </ion-refresher>
          <!-- /Refresh -->
          <ion-grid class="gap-md">
            <ion-row>
              <ion-col size="6" v-for="item in likeReceivedList" :key="item.likeSeq">
                <MyLikeCardItem
                  :item="item"
                  :subscribeInfo="subscribeInfo"
                  :is-buff-yn="isBuffYn"
                  :current-tab="currentTab"
                  @event="dailyCardDetail(item)"
                />
              </ion-col>
            </ion-row>
          </ion-grid>
          <ion-infinite-scroll
            :disabled="isEndScroll"
            threshold="100px"
            @ionInfinite="ionInfinite($event, 'receive')"
          >
            <ion-infinite-scroll-content
              loadingText="Please wait..."
              loadingSpinner="bubbles"
            ></ion-infinite-scroll-content>
          </ion-infinite-scroll>
          <!-- ë‚´ê°€ë°›ì€ì¢‹ì•„ìš” í™•ì¸ ëª¨ë‹¬ì°½ ì‹œì‘ -->
          <ion-modal
            :is-open="modalChoice2"
            @ionModalDidDismiss="modalChoice2 = false"
          >
            <ion-content>
              <ion-grid>
                <ion-row>
                  <ion-col>
                    <ion-text> ìˆ¨ê²¨ì§„ ì¹´ë“œë¥¼ í™•ì¸í•´ìš”</ion-text>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col>
                    <ion-text>
                      ë‚´ê°€ ë°›ì€ ì¢‹ì•„ìš” í™•ì¸ì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    </ion-text>
                    <br />
                    <ion-text>
                      ( ë‚´ê°€ ë°›ì€ ì¢‹ì•„ìš” í™•ì¸ x {{ this.coupon.quantity }}ê°œ )
                    </ion-text>
                  </ion-col>
                </ion-row>
              </ion-grid>
              <ion-grid>
                <ion-row>
                  <ion-col>
                    <ion-button
                      @click="profileModalBtn('cancel')"
                      fill="clear"
                      class="modal-btn"
                    >ì·¨ì†Œ
                    </ion-button>
                    <ion-button
                      @click="profileModalBtn('save2')"
                      fill="clear"
                      class="modal-btn"
                    >ì‚¬ìš©
                    </ion-button>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col>
                    <ion-text>
                      ( ë‚´ê°€ ë°›ì€ ì¢‹ì•„ìš” í™•ì¸ x {{ profileADitem }}ê°œ ì†Œëª¨ )
                    </ion-text>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-content>
          </ion-modal>
        </template>
        <!--   ë‚´ê°€ ë³´ë‚¸ ì¢‹ì•„ìš”    -->
        <template v-else>
          <ion-refresher slot="fixed" @ionRefresh="doRefresh($event, 'send')">
            <ion-refresher-content
              refreshing-spinner="circles"
              :pulling-icon="chevronDownCircleOutline"
            ></ion-refresher-content>
          </ion-refresher>
          <!--        <div class="infinite-list-container">-->
          <ion-grid class="gap-md">
            <ion-row>
              <ion-col size="6" v-for="item in sendList" :key="item.likeSeq">
                <MyLikeCardItem
                  :item="item"
                  :subscribeInfo="subscribeInfo"
                  :is-buff-yn="isBuffYn"
                  :current-tab="currentTab"
                  @event="sendListDailyCardDetail(item)"
                />
              </ion-col>
            </ion-row>
          </ion-grid>
          <ion-infinite-scroll
            :disabled="isEndScroll"
            threshold="100px"
            @ionInfinite="ionInfinite($event, 'send')"
          >
            <ion-infinite-scroll-content
              loadingText="Please wait..."
              loadingSpinner="bubbles"
            ></ion-infinite-scroll-content>
          </ion-infinite-scroll>
          <!--        </div>-->
          <!-- í—ˆë‹ˆë¶€ìŠ¤íŠ¸ ëª¨ë‹¬ì°½ ì‹œì‘ -->
          <HoneyBoostModal
            :is-open="modalChoice"
            :quantity="coupon.quantity"
            @ionModalDidDismiss="modalChoice = false"
            @ok="honeyModalBtn('save')"
            @cancel="honeyModalBtn('cancel')"
          />

          <!-- ëª¨ë‹¬ì°½ ë  -->

          <!-- TODO : ì´ë¯¸ì§€ í•˜ë‹¨ ìš°ì¸¡ ë²„íŠ¼ -->
          <!--
        <ion-fab-button
          @click.stop="profileModalBtn('openModal')"
          class="btn-bottom-right"
          fill="outline"
          shape="round"
        >
          <ion-icon :icon="iconChoice" />
        </ion-fab-button>
        -->
        </template>
      </div>
    </ion-content>
    <AlertMessageModal
      :is-open="alertMessage"
      :title="'NAVY'"
      :message="'íšŒì›ë‹˜ì€ í˜„ì¬ êµ¬ë… ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.'"
      :subMessage="'ìŠˆí¼ë¼ì´í¬ë¥¼ ì œì™¸í•œ ì¢‹ì•„ìš”ëŠ” êµ¬ë… ì´í›„ í™•ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤ğŸ˜¥ êµ¬ë…í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'"
      :btnName="'ì´ë™'"
      :height="210"
      :disabledCheck="false"
      @ionModalDidDismiss="alertMessage = false"
      @handleClickBtn="goRouter()"
    />
  </ion-page>
</template>

<script>
import {
  IonInfiniteScroll,
  IonInfiniteScrollContent,
  alertController,
  IonRefresher,
  IonRefresherContent
} from "@ionic/vue";
import { locationOutline, chevronDownCircleOutline } from "ionicons/icons";

import { getData, SS_USER_SEQ, dailyCardInfoMapFn, storeMapFn } from "@/assets/js/common";
import MyLikeTopNotice from "@/components/MyLike/MyLikeTopNotice.vue";
import MyLikeCardItem from "@/components/MyLike/MyLikeCardItem.vue";
import HoneyBoostModal from "@/components/Modal/HoneyBoostModal.vue";
import AlertMessageModal from "@/components/Modal/AlertMessageModal.vue";

//  TODO: ì•„ì´ì½˜ ì¶”í›„ êµì²´
import IconSample from "@/assets/img/icon/icon_mylike.svg";
import IconChoice from "@/assets/img/icon/icon_choice.svg";

export default {
  name: "MyLike",
  components: {
    IonInfiniteScrollContent,
    IonInfiniteScroll,
    MyLikeTopNotice,
    MyLikeCardItem,
    HoneyBoostModal,
    AlertMessageModal,
    IonRefresher,
    IonRefresherContent
  },
  computed: {
    likeReceivedList() {
      return this.$store.state.likeReceivedList;
    },
    ready() {
      return true;
    }
  },
  data() {
    return {
      chevronDownCircleOutline,

      iconChoice: IconChoice,
      iconSample: IconSample,
      locationOutline,
      currentTab: "my",
      pageNo: 0,
      pageSize: 15,
      currentReceivePageNo: 0,
      currentSendPageNo: 0,
      isEndScroll: false,

      receiveList: [],
      receiveLikeCnt: 0,
      sendList: [],
      coupon: "",
      couponCd: "",
      modalChoice: false,
      modalChoice2: false,
      // ì•„ì´í…œ ìˆ˜ëŸ‰(ì„ì‹œ)
      profileADitem: 1,
      isBuffYn: "",
      remainingTime: "",
      remainingTimeStr: "",

      subscribeInfo: {},
      alertMessage: false
    };
  },
  ionViewWillEnter() {
    this.getUserSubscribeInfo();
    this.getUserReceiveLikeCnt();
    // this.getBuffUsingInfo();
  },
  ionViewDidLeave() {
    // ì´ˆê¸°í™”
  },
  beforeMount() {
    this.getReceiveLike();
  },
  methods: {
    changeSegment(event) {
      this.currentTab = event.detail.value;
      if (this.currentTab == "my") {
        this.getReceiveLike();
        this.getUserReceiveLikeCnt();
      } else {
        this.getSendLike();
      }
      this.$refs.myLikeContent.$el.scrollToTop(0);
    },

    getBuffUsingInfo() {
      getData({
        url: "/getBuffUsingInfo",
        param: {
          couponCd: this.currentTab === "my" ? "CU003" : "CU002"
        },
        then: (data) => {
          this.isBuffYn = data.isBuffYn;
          this.remainingTime = data.remainingTime;
          this.remainingTimeStr = data.remainingTimeStr;
        }
      });
    },

    getUserSubscribeInfo() {
      getData({
        url: "/getUserSubscribeInfo",
        param: { infiniteActionCd: "RECEIVE_LIKE" },
        then: (data) => {
          this.subscribeInfo = data;
        }
      });
    },
    getUserReceiveLikeCnt() {
      getData({
        url: "/getUserReceiveLikeCnt",
        param: {},
        then: (data) => {
          this.receiveLikeCnt = data.receiveLikeCnt;
        }
      });
    },
    getReceiveLike() {
      // ì´ˆê¸°í™”
      this.pageNo = 0; //í˜ì´ì§€ ë„˜ë²„
      this.currentReceivePageNo = 0;
      this.isEndScroll = false;

      getData({
        url: "/getReceiveLike",
        param: {
          pageNo: this.pageNo
        },
        then: (data) => {
          // this.receiveList = data;
          this.$store.state.likeReceivedList = data;
        }
      });
    },
    getSendLike() {
      // ì´ˆê¸°í™”
      this.pageNo = 0; //í˜ì´ì§€ ë„˜ë²„
      this.currentSendPageNo = 0;
      this.isEndScroll = false;

      getData({
        url: "/getSendLike",
        param: {
          pageNo: this.pageNo
        },
        then: (data) => {
          this.sendList = data;
        }
      });
    },

    dailyCardDetail(item) {
      // if (item.superLikeYn === null) {
      //   dailyCardInfoMapFn({
      //     pageType: "myLike",
      //     likeSeq: null,
      //     superLikeMessage: null
      //   });
      // }
      if (item.superLikeYn === "Y") {
        dailyCardInfoMapFn({
          userKey: item.userKey,
          pageType: "myLike",
          likeSeq: item.likeSeq,
          nick: item.nick,
          superLikeMessage: item.superLikeMessage
        });
        this.$router.push("/dailyCardDetail");
      } else if (this.subscribeInfo.isActionInfinite == "Y") {
        // PUB
        dailyCardInfoMapFn({ userKey: item.userKey, pageType: "myLike", likeSeq: item.likeSeq, nick: item.nick });
        this.$router.push("/dailyCardDetail");
      } else {
        // êµ¬ë…ì•„ë‹ˆë¼ê³  ë„ì›Œì£¼ê¸°
        this.alertMessage = true;
        // this.warningAlertRouter(
        //   'ìŠˆí¼ë¼ì´í¬ë¥¼ ì œì™¸í•œ ì¢‹ì•„ìš”ëŠ” êµ¬ë… ì´í›„ í™•ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤ğŸ˜¥ êµ¬ë…í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
        // );
      }
    },
    sendListDailyCardDetail(item) {
      dailyCardInfoMapFn({ userKey: item.userKey, type: "sendLike" });
      this.$router.push("/dailyCardInfo");
    },
    goRouter() {
      this.modalMypage = false;
      this.alertMessage = false;
      storeMapFn({ subscribeYn: "Y" });
      this.$router.push("/store");
    },
    /** ëª¨ë‹¬ì°½ë‚´ ë‚´ìš© ë“¤ì–´ê°ˆì˜ˆì • **/
    profileModalBtn(type) {
      /*if (type === "openModal") {
        this.getUserCouponDataOne("honey");
      } else */if (type === "save") {
        this.useHoneyBoost();
      } else if (type === "confirmReceiveLike") {
        // this.getUserCouponDataOne('confirmReceiveLike');
        // this.$router.push("/subscription");
        // storeMapFn({subscribeYn: 'Y'});
        // this.$router.push('/store');
      } else if (type === "save2") {
        this.useReceivedLike();
      } else {
        this.modalChoice = false;
        this.modalChoice2 = false;
      }
    },
    /** í—ˆë‹ˆë¶€ìŠ¤íŠ¸ ë³´ìœ í˜„í™© **/
    getUserCouponDataOne(type) {
      let couponCd = "";
      if (type === "attack") {
        couponCd = "CU001";
      } else if (type === "honey") {
        couponCd = "CU002";
      } else if (type === "confirmReceiveLike") {
        couponCd = "CU003";
      }
      getData({
        url: "/getUserCouponDataOne",
        param: { couponCd: couponCd },
        then: (data) => {
          this.coupon = data;
          if (type === "honey") {
            this.modalChoice = true;
          } else if (type === "confirmReceiveLike") {
            this.modalChoice2 = true;
          }
        }
      });
    },
    /** useHoneyBoost ì‚¬ìš© ë¡œì§ **/
    useHoneyBoost() {
      getData({
        url: "/useHoneyBoost",
        param: {
          couponCd: "CU002",
          useType: "COUPON", // 'HEART', 'COUPON' / getUserCouponDataOne ì—ì„œ quantity(í˜„ì¬ì¿ í°ìˆ˜) ê°€ 0 ì¼ê²½ìš° HEART ë¡œ ë³´ë‚´ì£¼ë©´ ë¨
          itemCd: "", // useType 'HEART' ì¼ ì‹œ 1ê°œ ìˆ˜ëŸ‰ì¸ ì•„ì´í…œì½”ë“œ IT002_01
          pointCd: "" // useType 'HEART' ì¼ ì‹œ BUY
        },
        then: (data) => {
          if (
            data.successYn === "N" ||
            data.successYn === "NH" ||
            data.successYn === "NE"
          ) {
            this.warningAlert(data.message);
            this.$refs.modal.$el.dismiss();
          } else {
            this.warningAlert(data.message);
            this.isBuffYn = data.isBuffYn;
            this.remainingTime = data.remainingTime;
            this.remainingTimeStr = data.remainingTimeStr;
            this.modalChoice = false;
          }
        }
      });
    },
    /** useReceivedLike ì‚¬ìš© ë¡œì§ **/
    useReceivedLike() {
      getData({
        url: "/useReceivedLike",
        param: {
          couponCd: "CU003",
          useType: "COUPON", // 'HEART', 'COUPON' / getUserCouponDataOne ì—ì„œ quantity(í˜„ì¬ì¿ í°ìˆ˜) ê°€ 0 ì¼ê²½ìš° HEART ë¡œ ë³´ë‚´ì£¼ë©´ ë¨
          itemCd: "", // useType 'HEART' ì¼ ì‹œ 1ê°œ ìˆ˜ëŸ‰ì¸ ì•„ì´í…œì½”ë“œ IT002_01
          pointCd: "" // useType 'HEART' ì¼ ì‹œ BUY
        },
        then: (data) => {
          if (
            data.successYn === "N" ||
            data.successYn === "NH" ||
            data.successYn === "NE"
          ) {
            this.warningAlert(data.message);
            this.$refs.modal.$el.dismiss();
          } else {
            this.warningAlert(data.message);
            this.isBuffYn = data.isBuffYn;
            this.remainingTime = data.remainingTime;
            this.remainingTimeStr = data.remainingTimeStr;
            this.modalChoice2 = false;
          }
        }
      });
    },

    /** ê²½ê³ ì°½ **/
    async warningAlert(message) {
      const alert = await alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: ["OK"]
      });
      return alert.present();
    },
    /** ì´ë™ íŒì—…ì°½ **/
    async warningAlertRouter(message) {
      const alert = await alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: [
          {
            text: "ì·¨ì†Œ",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
            }
          },
          {
            text: "ì´ë™",
            handler: () => {
              this.$router.push("/subscription");
            }
          }
        ]
      });
      return alert.present();
    },
    /** ë¬´í•œìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ **/
    ionInfinite(event, type) {
      let self = this;

      // ìŠ¤í¬ë¡¤ ë¡œë”© ì…‹íƒ€ì„ì•„ì›ƒ
      setTimeout(function() {
        if (type === "receive") {
          self.pageNo = self.currentReceivePageNo + 1;
          getData({
            url: "/getReceiveLike",
            param: {
              pageNo: self.pageNo
            },
            then: (data) => {
              // if (!data.isExist) {
              //   return;
              // }
              self.currentReceivePageNo += 1;
              self.$nextTick(() => {
                for (let i in data) {
                  data[i]["pageNo"] = self.pageNo;
                  self.$store.state.likeReceivedList.push(data[i]);
                }
                if(data.length < 1){
                  self.isEndScroll = true;
                } else {
                  self.isEndScroll = false;
                }
              });
            }
          });
        } else {
          self.pageNo = self.currentSendPageNo + 1;
          getData({
            url: "/getSendLike",
            param: {
              pageNo: self.pageNo
            },
            then: (data) => {
              // if (!data.isExist) {
              //   return;
              // }
              self.currentSendPageNo += 1;
              self.$nextTick(() => {
                for (let i in data) {
                  data[i]["pageNo"] = self.pageNo;
                  self.sendList.push(data[i]);
                }
                if(data.length < 1){
                  self.isEndScroll = true;
                } else {
                  self.isEndScroll = false;
                }
              });
            }
          });
        }
        event.target.complete();
      }, 1000);
    },
    /** Refresh **/
    doRefresh(event, segmentType) {
      if (!this.ready) {
        event.target.complete();
        return;
      }

      if(segmentType == 'my'){
        this.getReceiveLike();
      } else {
        this.getSendLike();
      }
      this.getUserSubscribeInfo();
      this.getUserReceiveLikeCnt();

      setTimeout(() => {
        event.target.complete();
      }, 500);
    },
  }
};
</script>

<style scoped>
.infinite-list-container {
  padding: 14px 4px;
}

.btn-bottom-right {
  position: fixed;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  z-index: 4;
}
</style>
