<template>
  <ion-page>
    <custom-header page-name="Lounge"></custom-header>
    <ion-content v-if="homeLodingCheck === true">
      <!--<ContestCountDown style="margin-top: 20px" />-->
      <!-- Refresh -->
      <ion-refresher slot="fixed" @ionRefresh="doRefresh($event)">
        <ion-refresher-content
          refreshing-spinner="circles"
          :pulling-icon="chevronDownCircleOutline"
        ></ion-refresher-content>
      </ion-refresher>
      <!-- /Refresh -->
      <!-- ë©”ì¸ ë°°ë„ˆ -->
      <div class="ion-padding main-content">
        <MainBanner :bannerList="bannerList" v-if="bannerList.length > 0" />
        <!-- ë©”ì¸ CONTEST ë­í‚¹ TOP 10 -->
        <MainSection>
          <template #title>
            <MainSectionTitle
              title="BODY CONTEST"
              subTitle="ì°¸ê°€ì í›„ë³´ ëª©ë¡ - ìµœì‹ ì°¸ì—¬ìˆœ"
              color="#ffffff"
              :icon="trophyIcon"
            >
              <ion-text
                v-if="contestState != 'START'"
                color="light"
                class="text-sm"
                @click="$router.push('/contestHot')"
              >ì°¸ì—¬ì‹ ì²­í•˜ê¸°
              </ion-text>
            </MainSectionTitle>
          </template>
          <template #content>
            <MainContestSlider
              v-if="contestUserList.length > 0"
              :item-list="contestUserList"
              :loaded="!false"
              :contestState="contestState"
              @contestList="ContestSlider"
            />
            <div class="row-box" v-else>
              <CardBox>
                <div class="text-center">
                  <ion-text color="light" class="text-sm text-bold"
                            @click="$router.push('/contestHot')"
                  >
                    ì•„ì§ì€ ì°¸ì—¬ì‹ ì²­ìê°€ ì—†ìœ¼ë‹ˆ ì§€ê¸ˆ ë‹¹ì¥ ì°¸ì—¬í•´ì„œ<br />
                    ì»¨í…ŒìŠ¤íŠ¸ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš” :&#41;
                  </ion-text>
                </div>
              </CardBox>
            </div>
          </template>
        </MainSection>
        <MainSection>
          <!--        <MainSection v-if="hotPeopleList.length > 0">-->
          <template #title>
            <MainSectionTitle
              title="HOT PEOPLE"
              subTitle="ì§€ê¸ˆ, ê°€ì¥ í•«í•œ ì‚¬ëŒë“¤!!"
              color="#ffffff"
              :icon="hotPeopleIcon"
            >
            </MainSectionTitle>
          </template>
          <template #content>
            <!-- TODO: í•«í”¼í”Œ ì¹´í…Œê³ ë¦¬ -->
            <ion-segment
              v-model="hotpeopleCateCd"
              mode="ios"
              :scrollable="true"
              class="segment-chip auto-width pt-0 pb-0 pl-0"
            >
              <ion-segment-button
                v-for=" cate in hotpeopleCateList"
                :value="cate.cateCd"
                :key="cate.cateCd"
                class="shape-round"
                @click="categoryBtn(cate, 'hot')"
              >{{ cate.label }}
              </ion-segment-button>
            </ion-segment>
            <div class="row-box" v-if="hotPeopleList.length > 0">
              <MainHotPeopleSlider
                :item-list="hotPeopleList"
                :loaded="!false"
              />
            </div>
          </template>
        </MainSection>
        <!-- ë©”ì¸ HOT PLACE  -->
        <MainSection>
          <!--        <MainSection v-if="openChatList.length > 0">-->
          <template #title>
            <MainSectionTitle
              title="HOT ì†Œëª¨ì„"
              subTitle="ì§€ê¸ˆ, ê°€ì¥ ëœ¨ê±°ìš´ê³³ì€ ì—¬ê¸°!!"
              color="#ffffff"
              :icon="hotPlaceIcon"
            >
            </MainSectionTitle>
          </template>
          <template #content>
            <!-- TODO: ì†Œëª¨ì„ ì¹´í…Œê³ ë¦¬ -->
            <ion-segment
              v-model="openChatCateCd"
              mode="ios"
              :scrollable="true"
              class="segment-chip auto-width pt-0 pb-0 pl-0"
            >
              <ion-segment-button
                v-for=" cate in openChatCateList"
                :value="cate.cateCd"
                :key="cate.cateCd"
                class="shape-round"
                @click="categoryBtn(cate, 'openChat')"
              ># {{ cate.label }}
              </ion-segment-button>
            </ion-segment>
            <div class="row-box" v-if="openChatList.length > 0">
              <MainHotPlaceSlider
                :item-list="openChatList"
                :loaded="!false"
              />
            </div>
          </template>
        </MainSection>

        <!-- ë©”ì¸ PROFILE AD  -->
        <MainSection v-if="userNewList.length > 0">
          <template #title>
            <MainSectionTitle
              title="PROFILE AD"
              subTitle=""
              color="#ffffff"
              center
              :icon="profileAdIcon"
            >
              <ion-text
                color="light"
                class="text-sm"
                @click.stop="homeModalBtn('openModal')"
              >ë‚´ í”„ë¡œí•„ ê´‘ê³ í•˜ê¸°
              </ion-text>
            </MainSectionTitle>
          </template>
          <template #content>
            <MainProfileAdSlider :item-list="userNewList" :loaded="!false" />
          </template>
        </MainSection>
        <!-- ë©”ì¸ BEST TOPIC  -->
        <MainSection>
          <!--        <MainSection v-if="boardList.length > 0">-->
          <template #title>
            <MainSectionTitle
              title="BEST TOPIC"
              color="#ffffff"
              :icon="bestTophic"
            >
            </MainSectionTitle>
          </template>
          <template #content>
            <!-- TODO: BEST TOPIC ì¹´í…Œê³ ë¦¬ -->
            <ion-segment
              v-model="bestTopicCateCd"
              mode="ios"
              :scrollable="true"
              class="segment-chip auto-width pt-0 pb-0 pl-0"
            >
              <ion-segment-button
                v-for=" cate in bestTopicCateList"
                :value="cate.cateCd"
                :key="cate.cateCd"
                class="shape-round"
                @click="categoryBtn(cate, 'best')"
              >{{ cate.label }}
              </ion-segment-button>
            </ion-segment>
            <div class="row-box">
              <MainBestTopic :item-list="boardList" :loaded="!false" />
            </div>
          </template>
        </MainSection>
        <!-- ë©”ì¸ í•˜ë‹¨ ë°°ë„ˆ -->
        <MainBottomBanner />
      </div>

      <!-- ëª¨ë‹¬ì°½ ì‹œì‘ -->
      <ProfileAdModal
        :is-open="modalHome"
        :quantity="coupon.quantity"
        @ionModalDidDismiss="modalHome = false"
        @ok="homeModalBtn('save')"
        @cancel="modalHome = false"
      />

      <!-- ëª¨ë‹¬ì°½ ë  -->

      <AlertMessageModal
        :is-open="alertMessage"
        :title="'NAVY'"
        :message="'ì•„ì´í…œ ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'"
        :subMessage="'ì•„ì´í…œì„ êµ¬ë§¤í•˜ê¸°ìœ„í•´ ìƒì ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'"
        :btnName="'ì´ë™'"
        :height="210"
        :disabledCheck="false"
        @ionModalDidDismiss="alertMessage = false"
        @handleClickBtn="goRouter()"
      />
      <custom-footer />
    </ion-content>
    <ion-content v-if="homeLodingCheck === false">
      <PageLoadingCheck
        style="
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto;
          height: 100%;
        "
      />
    </ion-content>
  </ion-page>
</template>

<script>
import { chevronDownCircleOutline } from "ionicons/icons";
import {
  getData,
  messageTalkMapFn,
  communityViewMapFn,
  storeMapFn, openChatMeetMapFn, openChatMeetViewMapFn
} from "@/assets/js/common";
import MainBanner from "@/components/Home/MainBanner.vue";
import MainSection from "@/components/Home/MainSection.vue";
import MainSectionTitle from "@/components/Home/MainSectionTitle.vue";
import MainContestSlider from "@/components/Home/MainContestSlider.vue";
import MainHotPlaceSlider from "@/components/Home/MainHotPlaceSlider.vue";
import MainProfileAdSlider from "@/components/Home/MainProfileAdSlider.vue";
import MainHotPeopleSlider from "@/components/Home/MainHotPeopleSlider.vue";
import MainBestTopic from "@/components/Home/MainBestTopic.vue";
import MainBottomBanner from "@/components/Home/MainBottomBanner.vue";
import IconTrophy from "@/assets/img/icon/icon_trophy.svg";
import IconHotPlace from "@/assets/img/icon/icon_hot_place.svg";
import IconHotPeople from "@/assets/img/icon/icon_hot_people.svg";
import IconProfileAd from "@/assets/img/icon/icon_profile_ad.svg";
import IconBestTopic from "@/assets/img/icon/icon_best_topic.svg";
import IconAskMe from "@/assets/img/icon/icon_askme.svg";
import PageLoadingCheck from "@/components/PageLoadingCheck.vue";
import ProfileAdModal from "@/components/Modal/ProfileAdModal.vue";

import { FreeMode, Autoplay, Pagination, Navigation } from "swiper/modules";
import { IonRefresher, IonRefresherContent } from "@ionic/vue";
import { paperPlane } from "ionicons/icons";

//FCM
import { FCM } from "@capacitor-community/fcm";
import { PushNotifications } from "@capacitor/push-notifications";
import { Capacitor } from "@capacitor/core";
//GPS
import { Geolocation } from "@capacitor/geolocation";
//TOAST
import { toastController } from "@ionic/vue";

import appIcon from "@/assets/img/icon/appIcon.svg";
// import { nextTick } from 'vue';

// import { InAppPurchase2, IAPProduct } from '@ionic-native/in-app-purchase-2';
import AlertMessageModal from "@/components/Modal/AlertMessageModal";

export default {
  name: "HomePage",
  inject: ["alertController"],
  components: {
    IonRefresher,
    IonRefresherContent,
    MainBanner,
    MainSection,
    MainSectionTitle,
    MainContestSlider,
    MainHotPlaceSlider,
    MainProfileAdSlider,
    MainHotPeopleSlider,
    MainBestTopic,
    MainBottomBanner,
    PageLoadingCheck,
    ProfileAdModal,
    AlertMessageModal
  },
  computed: {
    chatroomId() {
      return this.$store.state.currentChatroomId;
    },
    currentMsgHeightCalc() {
      return this.$store.state.currentMsgHeightCalc;
    },
    meetMainTab() {
      return this.$store.state.currentMeetMainTab;
    }
  },
  data() {
    return {
      chevronDownCircleOutline,
      trophyIcon: IconTrophy,
      hotPlaceIcon: IconHotPlace,
      hotPeopleIcon: IconHotPeople,
      profileAdIcon: IconProfileAd,
      bestTophic: IconBestTopic,
      askMeIcon: IconAskMe,
      toastIcon: appIcon,
      openChatList: [],
      userList: [],
      //test
      interval: null,
      intervalLatLon: null,
      requestCnt: 0,
      responseCnt: 0,
      inputMs: 3,
      urlList: [
        //í…ŒìŠ¤íŠ¸í•  url
        "/test1",
        "/test2",
        "/test3"
      ],
      boardList: [],
      userNewList: [],
      //ë¡œë”© ì´ë¯¸ì§€ì²˜ë¦¬
      loadedImgsLength: 0,
      imgsLength: 0,
      modalHome: false,
      coupon: "",
      useType: "COUPON",
      // ì•„ì´í…œ ìˆ˜ëŸ‰(ì„ì‹œ)
      profileADitem: 1,
      homeLodingCheck: false,

      modules: [FreeMode, Autoplay, Pagination, Navigation],
      modalContest: false,
      paperPlane,
      contestList: [],

      contestUserList: [],
      contestState: "",

      /** ì¿ í° **/
      useTypeHeart: "COUPON",
      cupCheck: "",
      bannerList: [],

      pageNo: 1,
      pageSize: 30,
      currentPageNo: 1,
      totalCount: 0,
      isEndScroll: false,
      modalList: [],
      sessionNoticeList: [],
      hotPeopleList: [],
      hotAskMeList: [],
      openChatListMeeting: "",
      openChatListMoim: "",
      isOpenRef: false,
      alertMessage: false,

      // TODO : ì¹´í…Œê³ ë¦¬ í•«í”¼í”Œ
      hotpeopleCateCd: "season",
      hotpeopleCateList: [
        {
          cateCd: "season",
          label: "ì‹œì¦Œ"
        },
        {
          cateCd: "today",
          label: "ì˜¤ëŠ˜"
        },
        {
          cateCd: "weekly",
          label: "ì´ë²ˆì£¼"
        },
        {
          cateCd: "monthly",
          label: "ì´ë²ˆë‹¬"
        }
      ],
      // TODO : ì¹´í…Œê³ ë¦¬ ì†Œëª¨ì„
      openChatCateCd: "all",
      openChatCateList: [
        {
          cateCd: "all",
          label: "ì „ì²´"
        },
        {
          cateCd: "test5",
          label: "ìˆ ë²™ğŸº"
        },
        {
          cateCd: "test6",
          label: "ì·¨ë¯¸âš½"
        },
        {
          cateCd: "test7",
          label: "ì˜¨ë¼ì¸ğŸ®"
        }
      ],
      // TODO : ì¹´í…Œê³ ë¦¬ BEST TOPIC
      bestTopicCateCd: "all",
      bestTopicCateList: [
        {
          cateCd: "all",
          label: "ì „ì²´"
        },
        {
          cateCd: "today",
          label: "ì˜¤ëŠ˜"
        },
        {
          cateCd: "weekly",
          label: "ì´ë²ˆì£¼"
        }
      ]
    };
  },
  ionViewWillEnter() {
    //ì™¸ë¶€ì—ì„œ ì˜¤ë©´ ìƒˆë¡œìš´ ë©”ì‹œì§€ ëª©ë¡ì„ ê°€ì ¸ì™€ì•¼í•¨.
    //this.getNotifications();

    // ì§„ì…í•  ë•Œ í˜¸ì¶œ
    this.getHomeItemListAll();
    this.getContestUserList();
    this.getBannerList();
    //this.getHomeNoticeList();

    if (this.intervalLatLon == null) {
      this.intervalLatLon = setInterval(() => {
        //GPS ì²˜ë¦¬
        this.getGps();
      }, 15000);
    }
  },
  ionViewDidLeave() {
    // ë– ë‚  ë•Œ í˜¸ì¶œ
    clearInterval(this.interval);
    this.requestCnt = 0;
    this.responseCnt = 0;
  },
  mounted() {
    //GPS ì²˜ë¦¬(ìµœì´ˆì‹¤í–‰)
    this.getGps();

    //FCM Token ê°€ì ¸ì˜¤ê¸°
    this.getToken();

    //ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸° ì²˜ë¦¬
    //this.getNotifications();

    //this.presentToast('top', 'ì•ˆë…•í•˜ì„¸ìš”.');
  },

  methods: {
    /** Refresh **/
    doRefresh(event) {
      this.getHomeItemListAll();
      this.getContestUserList();

      setTimeout(() => {
        event.target.complete();
      }, 500);
    },
    pushClickFn(type, body, dataMap) {
      if (type === "message") {
        let testObj = { pushType: type, chatroomId: dataMap["chatroomId"] };
        this.presentToast("top", body, testObj);
      } else if (type === "openChat") {
        let testObj = { pushType: type, openChatKey: dataMap["openChatKey"] };
        this.presentToast("top", body, testObj);
      } else if (type === "openChatMessage") {
        let testObj = { pushType: type, chatroomId: dataMap["chatroomId"] };
        this.presentToast("top", body, testObj);
      } else if (type === "openChatComment") {
        let testObj = { pushType: type, chatroomId: dataMap["chatroomId"] };
        this.presentToast("top", body, testObj);
      } else if (type === "community") {
        let testObj = { pushType: type, articleKey: dataMap["articleKey"] };
        this.presentToast("top", body, testObj);
      } else if (type === "contestDetail") {
        let testObj = { pushType: type, articleKey: dataMap["articleKey"] };
        this.presentToast("top", body, testObj);
      } else if (type === "myLikeMatching") {
        let testObj = { pushType: type, chatroomId: dataMap["chatroomId"] };
        this.presentToast("top", body, testObj);
      } else if (type === "communityChat") {
        let testObj = { pushType: type, chatroomId: dataMap["chatroomId"] };
        this.presentToast("top", body, testObj);
      } else if (type === "myLike") {
        let testObj = { pushType: type };
        this.presentToast("top", body, testObj);
      } else {
        let testObj = { pushType: "else" };
        this.presentToast("top", body, testObj);
      }
    },
    categoryBtn(item, type) {
      if (type == "hot") {
        this.hotpeopleCateCd = item.cateCd;
        this.hotpeopleCategory();
      } else if (type == "openChat") {
        this.openChatCateCd = item.cateCd;
        this.openChatCategory();
      } else if (type == "best") {
        this.bestTopicCateCd = item.cateCd;
        this.bestTopicCategory();
      }
    },
    hotpeopleCategory() {
      getData({
        url: "/hotpeopleCategory",
        param: { category: this.hotpeopleCateCd },
        then: (data) => {
          this.hotPeopleList = data.hotPeopleList;
        }
      });
    },

    openChatCategory() {
      getData({
        url: "/openChatCategory",
        param: { category: this.openChatCateCd },
        then: (data) => {
          this.openChatList = data.openChatList;
        }
      });
    },

    bestTopicCategory() {
      getData({
        url: "/bestTopicCategory",
        param: { category: this.bestTopicCateCd },
        then: (data) => {
          this.boardList = data.articleList;
        }
      });
    },

    ContestSlider() {
      this.getContestUserList();
    },
    ionModalDidDismiss() {
      this.$refs.modal.$el.dismiss();
    },
    async presentToast(position, message, item) {
      const toast = await toastController.create({
        message: message,
        duration: 3500,
        position: position,
        icon: appIcon,
        header: "ë„¤ì´ë¹„",
        cssClass: "custom-toast",
        buttons: [
          {
            text: "test",
            role: "info",
            handler: () => {
              this.routeChange(item);
            }
          }
        ]
      });

      await toast.present();
    },
    routeChange(item) {
      if (
        item.pushType == "message" ||
        item.pushType == "myLikeMatching" ||
        item.pushType == "communityChat"
      ) {
        messageTalkMapFn({
          chatroomId: item.chatroomId,
          type: item.pushType,
          chatroomType: "first"
        });
        this.$router.push("/messageTalk");
      } else if (item.pushType == "openChat") {
        openChatMeetMapFn({ openChatKey: item.openChatKey, type: item.pushType });
        this.$router.push("/openChatMeet");
        // openChatViewMapFn({ openChatKey: item.openChatKey, type: item.pushType });
        // this.$router.push('/openChatView');
      } else if (item.pushType == "openChatMessage") {
        getData({
          url: "/getOpenChatKey",
          param: {
            chatroomId: item.chatroomId
          },
          then: (data) => {
            openChatMeetMapFn({ openChatKey: data.openChatKey, type: item.pushType, chatroomId: item.chatroomId });
            this.$router.push("/openChatMeet");
          }
        });
      } else if (item.pushType == "openChatComment") {
        getData({
          url: "/getOpenChatKey",
          param: {
            chatroomId: item.chatroomId
          },
          then: (data) => {

            getData({
              url: "/openChatMeetInfo",
              param: { meetKey: data.openChatKey },
              then: (meetInfo) => {
                openChatMeetViewMapFn({
                  openChatId: meetInfo.openChatId,
                  meetId: meetInfo.meetId,
                  categoryCd: meetInfo.categoryCd,
                  categoryNm: meetInfo.categoryNm,
                  openChatKey: meetInfo.openChatKey,
                  chatroomId: meetInfo.chatroomId
                });
                this.$router.push("/openChatMeetView");
              }
            });
          }
        });
      } else if (item.pushType == "community") {
        communityViewMapFn({ article: item.articleKey, type: item.pushType });
        this.$router.push("/communityView");
      } else if (item.pushType == "contestDetail") {
        communityViewMapFn({ article: item.articleKey, type: item.pushType });
        this.$router.push("/contestDetail");
      } else if (item.pushType == "myLike") {
        this.$router.push("/myLike");
      } else if (item.pushType == "else") {
        this.$router.push("/alarm");
      }
    },
    async presentToastToBottom(position, message) {
      const toast = await toastController.create({
        message: message,
        duration: 3500,
        position: position,
        icon: appIcon,
        cssClass: "custom-toast",
        buttons: [
          {
            text: "test",
            role: "info",
            handler: () => {
              //console.log('fake click event !!');
            }
          }
        ]
      });

      await toast.present();
    },
    async getGps() {
      if (Capacitor.getPlatform() !== "web") {
        await Geolocation.getCurrentPosition().then((position) => {
          //console.log('capacitor : ' + position.coords.latitude);
          getData({
            url: "/setUserLatLon",
            param: {
              lat: position.coords.latitude,
              lon: position.coords.longitude
            },
            then: () => {
            }
          });
        });
      } else {
        console.log("[ê°œë°œí™˜ê²½] web ì—ì„œ GPSëŠ” í™œì„±í™” ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        clearInterval(this.intervalLatLon);
      }
    },
    insertMessage(pushData) {
    },
    async getToken() {
      if (Capacitor.getPlatform() !== "web") {
        if (Capacitor.getPlatform() === "ios") {
          await this.addListeners();
          await this.registerNotifications();

          FCM.getToken()
            .then((result) => {
              //console.log('token:::'+JSON.stringify(result));
              // This is token for IOS
              this.setUserToken(result.token, "ios");
            })
            .catch((err) => {
              //í† í° ê°€ì ¸ì˜¤ê¸° ì—ëŸ¬
              //console.log(err);
              //alert("í† í°ê°€ì ¸ì˜¤ê¸° ì—ëŸ¬");
            });
        } else if (Capacitor.getPlatform() === "android") {
          await this.addListeners();
          await this.registerNotifications();

          FCM.getToken()
            .then((result) => {
              //console.log('token:::'+JSON.stringify(result));
              // This is token for Android
              this.setUserToken(result.token, "android");
            })
            .catch((err) => {
              //í† í° ê°€ì ¸ì˜¤ê¸° ì—ëŸ¬
              //console.log(err);
              //alert("í† í°ê°€ì ¸ì˜¤ê¸° ì—ëŸ¬");
            });
        }
      } else {
        console.log("[ê°œë°œí™˜ê²½] webì—ì„œ PushëŠ” í™œì„±í™” ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }

      if (Capacitor.getPlatform() === "android") {
        Geolocation.requestPermissions();
      }
    },
    async addListeners() {
      await PushNotifications.removeAllListeners();

      await PushNotifications.addListener("registration", (token) => {
        //console.info('Registration token: ', token.value);
        //this.setUserToken(token.value, "android");
      });

      await PushNotifications.addListener("registrationError", (err) => {
        //alert('Registration error: ', err.error);
        //console.error('Registration error: ', err.error);
      });

      await PushNotifications.addListener(
        "pushNotificationReceived",
        (notification) => {
          //console.log('Push notification received: ', notification);

          //alert('notification : ' + notification);
          //console.log("gggggggg", notification);
          //INSERT MESSAGE
          this.insertMessage(notification.data);
          if (notification.data.pushType == "message") {
            this.getMessageMainMap();
          }
          //ì±„íŒ…ì°½ê³¼ ë™ì¼í•˜ë‹¤ë©´
          if (
            this.$route.path === "/messageTalk" &&
            this.chatroomId == notification.data.chatroomId // ==ì„ ===ìœ¼ë¡œ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
          ) {
            let regexp = /(?:http(s?)?|www)\S+\w/g;
            let _match = notification.data.message.match(regexp);
            let match = [...new Set(_match)];
            notification.data["replaceMessage"] = notification.data.message;
            Array.from(match).forEach((item) => {
              if (!item.includes("http")) {
                notification.data["replaceMessage"] = notification.data[
                  "replaceMessage"
                  ].replaceAll(
                  item,
                  `<a href="http://${item}" target="_blank">${item}</a>`
                );
              } else {
                notification.data["replaceMessage"] = notification.data[
                  "replaceMessage"
                  ].replaceAll(
                  item,
                  `<a href="${item}" target="_blank">${item}</a>`
                );
              }
            });

            //ìì‹ ì˜ ê¸€ì´ë©´ ë¬´ì‹œí•œë‹¤. (chat, imageë§Œ)
            //if((notification.data.messageType == "Y") || (localStoporage.getItem("SS_USER_TOKEN") != notification.data.regUserKey)){
            this.$store.commit("addMessage", notification.data);

            //í˜„ì¬ ìœ„ì¹˜ê°€ 350pxì´ìƒ ì°¨ì´ê°€ ë‚œë‹¤ë©´ í† ìŠ¤íŠ¸ í˜¸ì¶œ
            if (this.currentMsgHeightCalc >= 350) {
              //í† ìŠ¤íŠ¸ í˜¸ì¶œ (í•˜ë‹¨)
              this.presentToastToBottom("bottom", notification.data.message);
            }
          } else if (
            this.$route.path === "/openChatMeet" &&
            this.chatroomId == notification.data.chatroomId &&
            this.meetMainTab == "message"
          ) {
            let regexp = /(?:http(s?)?|www)\S+\w/g;
            let _match = notification.data.message.match(regexp);
            let match = [...new Set(_match)];
            notification.data["replaceMessage"] = notification.data.message;
            Array.from(match).forEach((item) => {
              if (!item.includes("http")) {
                notification.data["replaceMessage"] = notification.data[
                  "replaceMessage"
                  ].replaceAll(
                  item,
                  `<a href="http://${item}" target="_blank">${item}</a>`
                );
              } else {
                notification.data["replaceMessage"] = notification.data[
                  "replaceMessage"
                  ].replaceAll(
                  item,
                  `<a href="${item}" target="_blank">${item}</a>`
                );
              }
            });

            //ìì‹ ì˜ ê¸€ì´ë©´ ë¬´ì‹œí•œë‹¤. (chat, imageë§Œ)
            //if((notification.data.messageType == "Y") || (localStoporage.getItem("SS_USER_TOKEN") != notification.data.regUserKey)){
            this.$store.commit("addMessage", notification.data);

            //í˜„ì¬ ìœ„ì¹˜ê°€ 350pxì´ìƒ ì°¨ì´ê°€ ë‚œë‹¤ë©´ í† ìŠ¤íŠ¸ í˜¸ì¶œ
            if (this.currentMsgHeightCalc >= 350) {
              //í† ìŠ¤íŠ¸ í˜¸ì¶œ (í•˜ë‹¨)
              this.presentToastToBottom("bottom", notification.data.message);
            }
          } else {
            //í˜„ì¬ ìœ„ì¹˜ê°€ ì±„íŒ…ì°½ì´ ì•„ë‹ˆë¼ë©´
            //í† ìŠ¤íŠ¸ í˜¸ì¶œ (ìƒë‹¨)
            this.pushClickFn(
              notification.data.pushType,
              notification.body,
              notification.data
            );
          }
        }
      );

      await PushNotifications.addListener(
        "pushNotificationActionPerformed",
        (notification) => {
          //alert('notification(push) : ' + notification);
          // alert("notification (ì™¸ë¶€) :: " + JSON.stringify(notification))
          this.routeChange(notification.notification.data);

          //console.log('Push notification action performed', notification.actionId, notification.inputValue);
        }
      );
    },
    async registerNotifications() {
      let permStatus = await PushNotifications.checkPermissions();

      if (permStatus.receive === "prompt") {
        permStatus = await PushNotifications.requestPermissions();
      }

      //alert(JSON.stringify(permStatus));
      if (permStatus.receive !== "granted") {
        //alert('ê¶Œí•œì´ ê±°ë¶€ë¨.');
        //alert('í‘¸ì‰¬ì•Œë¦¼ì„ í—ˆìš©í•´ìš”ì£¼ì„¸ìš”. ê±°ë¶€í•  ê²½ìš° ì •ìƒì ì¸ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì–´ë µìŠµë‹ˆë‹¤.');
        //throw new Error('User denied permissions!');
      }

      await PushNotifications.register();
    },
    async getNotifications() {
      if (Capacitor.getPlatform() !== "web") {
        await PushNotifications.getDeliveredNotifications().then((pushList) => {
          //alert('pushList'+ JSON.stringify(pushList));
          for (let idx in pushList) {
            //alert("pushList" + JSON.stringify(pushList[idx]));
            //this.insertMessage(pushList[idx]["notifications"]);
          }
        });
      }
    },

    setUserToken(token, platform) {
      getData({
        url: "/setUserToken",
        param: {
          token: token,
          platform: platform
        },
        then: () => {
        }
      });
    },

    /** ê²½ê³  íŒì—…ì°½ **/
    async warningAlert(message) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: ["OK"]
      });
      return alert.present();
    },

    getBannerList() {
      getData({
        url: "/getBannerList",
        param: { bannerType: "HOME" },
        then: (data) => {
          this.$nextTick(() => {
            let sampleList = data;
            this.bannerList = [...sampleList].sort(() => Math.random() - 0.5);
          });
        }
      });
    },

    getHomeItemListAll() {
      this.imgsLength = 0; //ì „ì²´ ì´ë¯¸ì§€ìˆ˜ ì´ˆê¸°í™”
      this.loadedImgsLength = 0; //ì¡°íšŒì™„ë£Œëœ ì´ë¯¸ì§€ìˆ˜

      getData({
        url: "/getHomeItemListAll",
        param: { contestType: 1, category: "all" },
        then: (data) => {
          this.openChatList = data.openChatList;
          this.boardList = data.articleList;
          this.userNewList = data.userAdList;
          this.hotPeopleList = data.hotPeopleList;
          this.hotAskMeList = data.hotAskMeList;
          this.homeLodingCheck = true;

          this.openChatListMeeting = data.openChatList.filter(
            (item) => item.partitionCd === "test3"
          );
          this.openChatListMoim = data.openChatList.filter(
            (item) => item.partitionCd === "test4"
          );

          this.$nextTick(() => {
            this.imgsLength = this.imgsLength + data.openChatList.length;
          });
        }
      });
    },
    getContestUserList() {
      getData({
        url: "/getHomeContestUserList",
        param: { contestType: 1 },
        then: (data) => {
          this.contestUserList = data.contestUserList;
          this.contestState = data.contestState;
        }
      });
    },
    /** ëª¨ë‹¬ì°½ë‚´ ë‚´ìš© ë“¤ì–´ê°ˆì˜ˆì • **/
    homeModalBtn(type) {
      if (type === "save") {
        this.useProfileAd();
      } else if (type === "openModal") {
        this.getUserCouponDataOne();
      }
    },
    /** useProfileAd ë³´ìœ í˜„í™© **/
    getUserCouponDataOne() {
      getData({
        url: "/getUserCouponDataOne",
        param: { couponCd: "CU010" },
        then: (data) => {
          this.coupon = data;
          if (data.quantity > 0) {
            this.useType = "COUPON";
          } else {
            this.useType = "HEART";
          }
          this.$nextTick(() => {
            this.modalHome = true;
          });
        }
      });
    },
    /** useProfileAd ì‚¬ìš© ë¡œì§ **/
    useProfileAd() {
      getData({
        url: "/useProfileAd",
        param: {
          couponCd: "CU010",
          useType: "COUPON",
          itemCd: "",
          pointCd: ""
          // ìˆ˜ëŸ‰ 0ì¼ë•Œ í•˜íŠ¸ë¡œ êµ¬ë§¤
          // useType: this.useType, // 'HEART', 'COUPON' / getUserCouponDataOne ì—ì„œ quantity(í˜„ì¬ì¿ í°ìˆ˜) ê°€ 0 ì¼ê²½ìš° HEART ë¡œ ë³´ë‚´ì£¼ë©´ ë¨
          // itemCd: this.useType === "HEART" ? "IT010_01" : "", // useType 'HEART' ì¼ ì‹œ 1ê°œ ìˆ˜ëŸ‰ì¸ ì•„ì´í…œì½”ë“œ
          // pointCd: this.useType === "HEART" ? "BUY" : "" // useType 'HEART' ì¼ ì‹œ BUY
        },
        then: (data) => {
          if (
            data.successYn === "N" ||
            data.successYn === "NH" ||
            data.successYn === "NE"
          ) {
            this.alertMessage = true;
            // this.warningAlert(data.message);
            // this.modalHome = false;
          } else {
            this.modalHome = false;
            this.getHomeItemListAll();
          }
        }
      });
    },
    getMessageMainMap() {
      getData({
        url: "/messageMain/getMessageMainMap",
        param: {},
        then: (data) => {
          this.$nextTick(() => {
            this.$store.state.messageMainMap = data;
          });
        }
      });
    },

    goRouter() {
      this.modalHome = false;
      this.alertMessage = false;
      storeMapFn({ categoryType: "item" });
      this.$router.push("/store");
    },
    /** ê²½ê³  íŒì—…ì°½ **/
    async warningAlertNH(message) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: [
          {
            text: "ì·¨ì†Œ",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
            }
          },
          {
            text: "ì´ë™",
            handler: () => {
              this.$router.push("/store");
              this.modalContest = false;
            }
          }
        ]
      });
      return alert.present();
    }
  }
};
</script>

<style scoped lang="scss">
.main-content {
  background: var(--ion-color-dark);
}
</style>
