<template>
  <ion-page>
    <custom-header page-name="Setting"></custom-header>
    <ion-content class="ion-padding">
      <!-- í”„ë¡œí•„ ì¹´ë“œ -->
      <MyPageProfile
        :thumbnail="cdnThumbNm"
        :user="user"
        :nickState="nickState"
        :customFormatter="customFormatter"
        :isNicknameValid="isNicknameValid"
        @validateNickname="validateNickname"
        @updateNickname="nickUpdateClick"
        @saveNickname="nickSaveClick"
        @cancelNickname="nickCancelClick"
        @validateNickFalse="nickSaveFalse"
        v-model:value="afterNick"
        @dailyCardInfo="goDailyCardInfo"
      />
      <NickChangeModal
        :is-open="nickChangeModal"
        :title="'ë‹‰ë„¤ì„ ë³€ê²½'"
        :userNick="userNick"
        @ionModalDidDismiss="nickChangeModal = false"
        @userChangeNick="userChangeNick"
      />
      <div class="row-box">
        <CardBox padding="none" class="my-point-info">
          <ion-list lines="none">
            <ion-item>
              <ion-icon
                slot="start"
                :icon="heartIcon"
                color="light"
                size="large"
              ></ion-icon>
              <ion-text class="text-md" color="light" @click="setUserEncoding"
              >ë‚´ í•˜íŠ¸ <strong class="text-bold">{{ heart }}</strong
              >ê°œ
              </ion-text>

              <ion-text
                slot="end"
                color="light"
                class="text-md text-bold text-link"
                @click="couponModal = true"
              >ì¿ í°ë³´ê´€í•¨
              </ion-text>
            </ion-item>
            <ion-item>
              <ion-icon
                slot="start"
                :icon="pointIcon"
                color="light"
                size="large"
              ></ion-icon>
              <ion-text class="text-md" color="light">
                ë‚´ í¬ì¸íŠ¸ <strong class="text-bold">{{ point }}</strong> P
              </ion-text>
              <ion-text
                slot="end"
                color="light"
                class="text-md text-bold text-link"
                @click="$router.push('/usePointDetails')"
              >ìì„¸íˆë³´ê¸°
              </ion-text>
            </ion-item>
            <ion-item v-if="isPartner == 'Y'">
              <ion-icon
                slot="start"
                :icon="pointIcon"
                color="light"
                size="large"
              ></ion-icon>
              <ion-text class="text-md" color="light">
                íŒŒíŠ¸ë„ˆ í¬ì¸íŠ¸ <strong class="text-bold">{{ currentPoint }}</strong>
                P
              </ion-text>
              <ion-text
                slot="end"
                color="light"
                class="text-md text-bold text-link"
                @click="partners"
              >ìì„¸íˆë³´ê¸°
              </ion-text>
            </ion-item>
          </ion-list>
        </CardBox>
      </div>
      <!-- í”Œë˜í‹°ë„˜ íŒ¨ìŠ¤ êµ¬ë… -->
      <div class="row-box">
        <MyPlatinumBanner
          :subscribeInfo="subscribeInfo"
          :myLikeCnt="myLikeCnt"
          @goBuySubscribe="goBuySubscribe"
          @goMyLike="goMyLike"
          @cancelSubscribe="cancelSubscribe"
        />
      </div>
      <div class="row-box">
        <AskMeLink
          :askMeInfo="askMeInfo"
          :askMeUrl="askMeUrl"
          @setAskMeCode="setAskMeCode"
          @setClipBoard="setClipBoard"
          detail
        />
      </div>
      <!-- ì´ë™ ë©”ë‰´ -->
      <div class="row-box" v-if="isPartner == 'Y'">
        <ion-list lines="none">
          <MyPageNavButtonItem
            title="íŒŒíŠ¸ë„ˆìŠ¤ ê´€ë¦¬ì"
            @click="partners"
          />
          <!--          <MyPageNavButtonItem-->
          <!--            title="ë°›ì€ ìª½ì§€ í™•ì¸"-->
          <!--            @click="$router.push('/letter')"-->
          <!--          />-->
        </ion-list>
      </div>
      <div class="row-box">
        <MyPageNavList @profileModalBtn="profileModalBtn('openModal')" :isPartner="isPartner" />
      </div>

      <StoreCouponModal
        :is-open="couponModal"
        @dismissedModal="couponModal = false"
      />
      <!-- ëª¨ë‹¬ì°½ ì‹œì‘ -->
      <ProfileAdModal
        :is-open="modalMypage"
        :quantity="coupon.quantity"
        @ionModalDidDismiss="modalMypage = false"
        @ok="profileModalBtn('save')"
        @cancel="profileModalBtn('cancel')"
      />
      <AlertMessageModal
        :is-open="alertMessage"
        :title="'NAVY'"
        :message="'ì•„ì´í…œ ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'"
        :subMessage="'ì•„ì´í…œì„ êµ¬ë§¤í•˜ê¸°ìœ„í•´ ìƒì ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'"
        :btnName="'ì´ë™'"
        :height="210"
        :disabledCheck="false"
        @ionModalDidDismiss="alertMessage = false"
        @handleClickBtn="goRouter()"
      />
      <!-- ëª¨ë‹¬ì°½ ë  -->
    </ion-content>
  </ion-page>
</template>

<script>
import MyPageProfile from "@/components/MyPage/MyPageProfile.vue";
import MyPageNavList from "@/components/MyPage/MyPageNavList.vue";
import MyPageNavButtonItem from "@/components/MyPage/MyPageNavButtonItem.vue";
import MyPlatinumBanner from "@/components/MyPage/MyPlatinumBanner.vue";
import CardBox from "@/components/CardBox.vue";
import ProfileAdModal from "@/components/Modal/ProfileAdModal.vue";
import NickChangeModal from "@/components/Modal/NickChangeModal.vue";
import AskMeLink from "@/components/AskMe/AskMeLink.vue";

import IconMyHeart from "@/assets/img/icon/icon_my_heart.svg";
import IconMyPoint from "@/assets/img/icon/icon_my_point.svg";

import StoreCouponModal from "@/components/Store/StoreCouponModal.vue";
import AlertMessageModal from "@/components/Modal/AlertMessageModal.vue";

import { getData, dailyCardInfoMapFn, storeMapFn } from "@/assets/js/common";

import { copyOutline } from "ionicons/icons";
import { Clipboard } from "@capacitor/clipboard";
import { toastController } from "@ionic/vue";

export default {
  inject: ["alertController"],
  name: "MyPage",
  components: {
    NickChangeModal,
    StoreCouponModal,
    MyPageProfile,
    MyPageNavList,
    MyPageNavButtonItem,
    MyPlatinumBanner,
    ProfileAdModal,
    CardBox,
    AlertMessageModal,
    AskMeLink
  },
  data() {
    return {
      copyOutline,

      heartIcon: IconMyHeart,
      pointIcon: IconMyPoint,

      user: {},
      userNick: "",
      cdnThumbNm: "",

      nickState: "",
      afterNick: "",
      heart: 0,
      point: 0,
      isNicknameValid: true,

      modalMypage: false,
      coupon: "",
      // ì•„ì´í…œ ìˆ˜ëŸ‰(ì„ì‹œ)
      profileADitem: 1,

      subscribeInfo: {
        subscribeCd: "",
        subscribeNm: "",
        startDate: "yyyy.mm.dd",
        endDate: "yyyy.nn.dd"
      },

      couponModal: false,
      nickChangeModal: false,

      myLikeCnt: 0,
      alertMessage: false,

      askMeInfo: {},
      //baseUrl: 'http://localhost:8100/askMe/',
      // baseUrl: 'http://110.10.189.102:8031/askMe/',
      baseUrl: "http://navy-ask.me/askMe/",
      askMeUrl: "",

      isPartner: "non-checked",
      currentPoint: 0
    };
  },
  ionViewWillEnter() {
    // ì§„ì…í•  ë•Œ í˜¸ì¶œ
    this.getUserSubscribeInfo();
    this.getUser();
    this.nickState = "";
    this.afterNick = "";

    // ASKME
    this.getUserByAskMeCode();

    //partnersCheck
    this.partnersCheck();
  },
  ionViewDidLeave() {
    // ì´ˆê¸°í™”
  },
  mounted() {
  },

  methods: {
    /*setComma(arg) {
      return arg.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
    },*/
    // íŒŒíŠ¸ë„ˆ ê³„ì •ì¸ì§€ ì²´í¬
    partnersCheck() {
      let self = this;
      getData({
        url: "/partnersCheck",
        param: {},
        then: (data) => {
          if (data.isPartner == "Y") {
            if (Object.keys(data.partnersCode).length > 0) {
              getData({
                url: "/partnersInfo",
                param: {
                  partnersCode: data.partnersCode
                },
                then: (info) => {
                  if (info.successYn == "Y") {
                    self.isPartner = "Y";
                    self.currentPoint = info.result.currentPoint;
                    // partnersMapFn(info.result);
                  }
                }
              });
            }
          } else {
            self.isPartner = "N";
          }
        }
      });
    },

    getUserSubscribeInfo() {
      getData({
        url: "/getUserSubscribeInfo",
        param: {},
        target: this,
        then: (data) => {
          this.subscribeInfo = data;
        }
      });
    },
    userChangeNick() {
      this.nickChangeModal = false;
      this.getUser();
    },
    goBuySubscribe() {
      // this.$router.push("/subscription_Shop");
      storeMapFn({ subscribeYn: "Y" });
      this.$router.push("/store");
    },
    goMyLike() {
      this.$router.push("/myLike");
    },
    cancelSubscribe() {
      getData({
        url: "/cancelSubscribe",
        param: {},
        target: this,
        then: () => {
          this.$nextTick(() => {
            this.getUserSubscribeInfo();
          });
        }
      });
    },
    getResult() {
      var resultObj = {};

      return resultObj;
    },
    /** ë§ˆì´í˜ì´ì§€ ìœ ì €ì •ë³´ **/
    getUser() {
      getData({
        url: "/getSettingMainUserInfo",
        param: {},
        target: this,
        then: (data) => {
          this.user = data;
          this.userNick = this.user.nick;
          this.cdnThumbNm = data.cdnThumbNm;
          this.heart = data.lastPoint;
          this.point = data.invitePoint ? data.invitePoint : 0;
          this.myLikeCnt = data.myLikeCnt ? data.myLikeCnt : 0;
        }
      });
    },
    nickUpdateClick() {
      this.afterNick = this.user.nick;
      this.nickState = "update";
      this.nickChangeModal = true;
    },
    nickSaveClick() {
      if (!this.isNicknameValid || this.afterNick === "") {
        return;
      } else {
        this.btnHandler();
      }
    },
    nickCancelClick() {
      this.nickState = "";
      this.isNicknameValid = true;
    },
    nickSaveFalse() {
      this.nickState = "";
      this.isNicknameValid = true;
      this.warningAlert("ì¤‘ë³µëœ ë‹‰ë„¤ì„ìœ¼ë¡œ ë³€ê²½í• ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    },
    /** ëª¨ë‹¬ì°½ë‚´ ë‚´ìš© ë“¤ì–´ê°ˆì˜ˆì • **/
    profileModalBtn(type) {
      if (type === "openModal") {
        this.getUserCouponDataOne();
      } else if (type === "save") {
        this.useProfileAd();
      } else {
        this.modalMypage = false;
      }
    },
    /** useProfileAd ë³´ìœ í˜„í™© **/
    getUserCouponDataOne() {
      getData({
        url: "/getUserCouponDataOne",
        param: { couponCd: "CU010" },
        then: (data) => {
          this.coupon = data;
          this.$nextTick(() => {
            this.modalMypage = true;
          });
        }
      });
    },
    /** íŒŒíŠ¸ë„ˆìŠ¤ ê´€ë¦¬ì **/
    partners() {
      // this.warningAlert(
      //   'ì˜¤í”ˆ ì˜ˆì •ì…ë‹ˆë‹¤ !<br />ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš” ğŸ˜¥<br />[ 23.09ì›” ì¤‘ ]'
      // );
      if (!partnersMap.updDate) {
        this.partnersRouteAlert();
      } else {
        this.$router.push("/partnersAdmin");
      }
    },
    /** useProfileAd ì‚¬ìš© ë¡œì§ **/
    useProfileAd() {
      getData({
        url: "/useProfileAd",
        param: {
          couponCd: "CU010",
          useType: "COUPON", // 'HEART', 'COUPON' / getUserCouponDataOne ì—ì„œ quantity(í˜„ì¬ì¿ í°ìˆ˜) ê°€ 0 ì¼ê²½ìš° HEART ë¡œ ë³´ë‚´ì£¼ë©´ ë¨
          itemCd: "", // useType 'HEART' ì¼ ì‹œ 1ê°œ ìˆ˜ëŸ‰ì¸ ì•„ì´í…œì½”ë“œ IT002_01
          pointCd: "" // useType 'HEART' ì¼ ì‹œ BUY
        },
        then: (data) => {
          if (
            data.successYn === "N" ||
            data.successYn === "NH" ||
            data.successYn === "NE"
          ) {
            // this.warningAlert(data.message);
            // this.modalMypage = false;
            this.alertMessage = true;
          } else {
            this.modalMypage = false;
          }
        }
      });
    },
    goRouter() {
      this.modalMypage = false;
      this.alertMessage = false;
      storeMapFn({ categoryType: "item" });
      this.$router.push("/store");
    },

    goDailyCardInfo() {
      dailyCardInfoMapFn({ userKey: this.user.userKey, type: "mypage" });
      this.$router.push("/dailyCardInfo");
    },
    /** ê¸€ììˆ˜ ì²´í¬ **/
    customFormatter(inputLength, maxLength) {
      if (inputLength > maxLength) {
        return "ë”ì´ìƒ ì…ë ¥í• ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      } else if (inputLength < 1) {
        return `ìµœì†Œ ${1 - inputLength}ì / ìµœëŒ€ 8ì`;
      } else {
        return `ìµœì†Œ ê¸€ììˆ˜ ì™„ë£Œ / ìµœëŒ€ ${maxLength - inputLength}ì`;
      }
    },
    /** íŠ¹ìˆ˜ë¬¸ì ë° ë„ì–´ì“°ê¸°, ììŒ+ëª¨ìŒ ì²´í¬ ì •ê·œì‹ **/
    validateNickname(e) {
      // ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ìˆ˜ë¬¸ì ë° ììŒ/ëª¨ìŒë§Œ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
      const regex = /[{}[\]/?.,;:|)*~`!^\-_+<>@#$%&\\=('"]/g;
      const regex2 = /\s/g;
      // const regex3 = /([^ê°€-í£a-z\x20])/i;
      const regex3 = /[^ê°€-í£a-zA-Z0-9_\s]/g;

      this.isNicknameValid =
        !regex.test(e.target.value) &&
        !regex2.test(e.target.value) &&
        !regex3.test(e.target.value);
    },
    /** ê²½ê³  íŒì—…ì°½ **/
    async warningAlert(message) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: ["OK"]
      });
      return alert.present();
    },
    /** ì €ì¥ **/
    async btnHandler() {
      const alert = await this.alertController.create({
        //cssClass: 'my-custom-class',
        header: "",
        message:
          `'` +
          this.afterNick +
          `'(ë‹˜) ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? <br />*ë³€ê²½ í›„ 30ì¼ë™ì•ˆ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`,
        buttons: [
          {
            text: "ì·¨ì†Œ",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
              this.nickState = "";
              this.isNicknameValid = true;
            }
          },
          {
            text: "ì™„ë£Œ",
            handler: () => {
              getData({
                url: "/changeUserNick",
                param: {
                  beforeNick: this.user.nick,
                  afterNick: this.afterNick
                },
                then: (data) => {
                  if (data.successYn === "N") {
                    this.nickState = "";
                    this.warningAlert(data.message);
                  } else {
                    this.nickState = "";
                    this.user.nick = this.afterNick;
                    this.warningAlert("ë³€ê²½ì™„ë£Œ");
                  }
                }
              });
            }
          }
        ]
      });
      return alert.present();
    },

    async partnersRouteAlert() {
      let self = this;
      const alert = await this.alertController.create({
        //cssClass: 'my-custom-class',
        header: "",
        message: "íŒŒíŠ¸ë„ˆìŠ¤ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br />ì§€ê¸ˆ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        buttons: [
          {
            text: "ì•„ë‹ˆìš”",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
            }
          },
          {
            text: "ë„¤",
            handler: () => {
              self.$router.push("/partnersSetting");
            }
          }
        ]
      });
      return alert.present();
    },

    getUserByAskMeCode() {
      getData({
        url: "/askMe/getUserAskMe",
        param: {
          pageNo: 1,
          pageSize: 1
        },
        then: (data) => {
          this.askMeInfo = data.askMeInfo;
          // this.askMeList = data.askMeList.result;
          // this.nick = data.askMeInfo.nick;
          if (data.askMeInfo.askMeCode != null) {
            this.askMeUrl = this.baseUrl + data.askMeInfo.askMeCode;
          }
        }
      });
    },
    setAskMeCode() {
      getData({
        url: "/askMe/setAskMeCode",
        param: {},
        then: (data) => {
          if (data.successYn === "N") {
            this.warningAlert(data.message);
          } else {
            this.askMeInfo = data.askMeInfo;
            if (data.askMeInfo.askMeCode != null) {
              this.askMeUrl = this.baseUrl + data.askMeInfo.askMeCode;
            }
          }
        }
      });
    },
    async setClipBoard() {
      await Clipboard.write({
        url: this.askMeUrl
      });
      await this.presentToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    },
    /** í† ìŠ¤íŠ¸íŒì—… **/
    async presentToast(message) {
      const toast = await toastController.create({
        message: message,
        duration: 1000,
        position: "middle" // top, middle, bottom
      });
      await toast.present();
    },

    setUserEncoding() {
      return;
      // getData({
      //   url: '/setUserEncoding',
      //   param: {},
      //   then: (data) => {}
      // });
    }
  }
};
</script>

<style lang="scss" scoped>
.my-point-info {
  ion-item {
    + ion-item {
      margin-top: -14px;
    }
  }
}
</style>
