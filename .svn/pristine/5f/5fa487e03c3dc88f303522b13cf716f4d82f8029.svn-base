<template>
  <ion-page>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <BackButton @event="prevPage" :custom="true" />
        </ion-buttons>
        <ion-title>{{ chatDetailMap.partitionNm }}</ion-title>
        <ion-buttons slot="end">
          <custom-button id="openChat-popover-button">
            <ion-icon slot="icon-only" :icon="menuIcon" color="light" />
          </custom-button>
          <ion-popover
            trigger="openChat-popover-button"
            :dismiss-on-select="true"
            mode="ios"
          >
            <ion-content>
              <ion-list lines="full">
                <template v-if="ssUserYn === 'Y'">
                  <ion-item
                    :button="true"
                    :detail="false"
                    @click="editOpenChat(chatDetailMap)"
                  >ìˆ˜ì •
                  </ion-item>
                  <ion-item
                    :button="true"
                    :detail="false"
                    @click="presentAlertConfirm()"
                  >ì‚­ì œ
                  </ion-item>
                </template>
                <template v-else>
                  <ion-item :button="true" :detail="false" @click="policeBtn"
                  >ì‹ ê³ 
                  </ion-item>
                </template>
              </ion-list>
            </ion-content>
          </ion-popover>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding" v-if="openChatLodingCheck === true">
      <PageLoadingCheck
        v-if="lodingCheck !== false"
        style="position: fixed; top: 48%; left: 48%; z-index: 9999"
      />
      <!-- ìƒë‹¨ ì‘ì„±ì   -->
      <OpenChatViewUserInfo
        :user="chatDetailMap"
        :reg-date="regDate"
        :thumbnail="cdnThumbNmProfile"
        @event="profileInfo(this.regUserKey)"
      />
      <!--   ë‚´ìš©    -->
      <div>
        <ion-img
          v-bind:src="
            cdnNm !== ''
              ? 'https://' + cdnNm
              : require('../../assets/img/Loading_icon.gif')
          "
          @ionError="
            $event.srcElement.src = require('../../assets/img/Loading_icon.gif')
          "
        ></ion-img>
        <!--   ì œëª©   -->
        <div class="row-box">
          <ion-row class="ion-align-items-center ion-justify-content-between">
            <ion-text color="light" class="text-xl text-bold">
              {{ chatDetailMap.title }}
            </ion-text>
            <!--<ion-img
              @click="openUseOpenChatModal"
              :src="'https://cmdg.speedycdn.net/202308/20230808143353_5905a0f6-1461-4d41-ac99-6b4c8c41dd0d.png'"
              style="width:35px; height: 35px;"
            />-->
            <ion-label @click="openUseOpenChatModal">
              <ion-chip class="chip-sm chip-secondary"
              >ğŸ”¥í˜„ì¬ {{ openchatRank }}ìœ„ ëª¨ì„
              </ion-chip>
            </ion-label>
          </ion-row>
        </div>
        <!--   ë‚´ìš©    -->
        <div class="row-box">
          <p>
            <ion-text color="light" class="text-md" v-html="chatDetailMap.replaceContent"></ion-text>
          </p>
        </div>
        <!-- ì°¸ì—¬ ì‹ ì²­ì --> <!-- v-if="chatDetailMap.regUserKey === chatDetailMap.ssUserKey" -->
        <div class="row-box" v-if="isLeader">
          <OpenChatViewAttendList>
            <template #content>
              <OpenChatViewAttendItem
                v-for="(item, idx) in attendInfoList"
                :key="idx"
                :item="item"
                @event="profileInfo(item.userKey)"
                @ok="agreeYn('Y', item.userKey)"
                @cancel="agreeYn('N', item.userKey)"
              />
            </template>
          </OpenChatViewAttendList>
        </div>
        <!-- ì˜¤í”ˆì±— ë°© í™œì„±/ ë¹„í™œì„±í™” --> <!-- v-if="chatDetailMap.regUserKey === chatDetailMap.ssUserKey" -->
        <div class="row-box" v-if="isLeader">
          <CustomCardItem :clear="true">
            <ion-label style="margin: 0">
              <OpenChatPrivate
                :privateYn="privateYn"
                @toggle="setCheckPrivateYn($event)"
              />
            </ion-label>
          </CustomCardItem>
        </div>

        <!-- ìµœê·¼ í™œë™ ì‹œê°„ -->
        <div class="row-box" v-if="recentTime">
          <CustomCardItem :clear="true">
            <ion-label>
              <ion-row class="gap-md ion-align-items-center" style="text-align: center !important;">
                <ion-text color="light">
                  <span v-if="recentTime != 'ë°©ê¸ˆ ì „'" style="font-size: 12px;"> ë°©ì¥ì´ {{ recentTime }} ë§ˆì§€ë§‰ìœ¼ë¡œ í™œë™í–ˆìŠµë‹ˆë‹¤. </span>
                  <span v-else style="font-size: 12px; color: #f1f157;"> ë°©ì¥ì´ í˜„ì¬ í™œë™ ì¤‘ ì…ë‹ˆë‹¤ </span>
                </ion-text>
              </ion-row>
            </ion-label>
          </CustomCardItem>
        </div>
        <!--   í•˜ë‹¨ ì‹œê°„ ë° ì¥ì†Œ   -->
        <div class="row-box">
          <CustomCardItem :clear="true">
            <ion-label>
              <ion-row class="gap-md ion-align-items-center">
                <ion-icon color="secondary" :icon="calendarIcon"></ion-icon>
                <ion-text color="light">
                  <template v-if="dueDate === 'ìƒì‹œ ëª¨ì§‘'">
                    {{ dueDate }}
                  </template>
                  <template v-else>
                    {{ chatDetailMap.dueDate }} &nbsp; {{ dueDate }}
                  </template>
                </ion-text>
              </ion-row>
            </ion-label>
          </CustomCardItem>
        </div>
        <div class="row-box">
          <CustomCardItem :clear="true">
            <ion-label>
              <ion-row class="gap-md ion-align-items-center">
                <ion-icon color="secondary" :icon="locationOutline"></ion-icon>
                <ion-text color="light">
                  <template v-if="chatDetailMap.location === ''">
                    ì•„ì§ ì¥ì†Œê°€ ì •í•´ì§€ì§€ ì•Šì•˜ì–´ìš”!
                  </template>
                  <template v-else>
                    {{ chatDetailMap.location }}
                  </template>
                </ion-text>
              </ion-row>
            </ion-label>
          </CustomCardItem>
        </div>
        <!--   /í•˜ë‹¨ ì‹œê°„ ë° ì¥ì†Œ   -->
      </div>

      <!-- ëª¨ì„ë¶€ìŠ¤íŠ¸ ëª¨ë‹¬ì°½ ì‹œì‘ -->
      <CustomBoostModal
        :is-open="boostModal"
        :isBuffYn="isBuffYn"
        :coupon="coupon"
        :openchatRank="openchatRank"
        :totalRoom="totalRoom"
        :useCnt="useCnt"
        :calTimeStr="calTimeStr"
        @ionModalDidDismiss="boostModalClose"
        @close="boostModalClose"
        @event="useOpenChatBoost"
      />
    </ion-content>
    <ion-content v-if="openChatLodingCheck === false" :disabled="true">
      <PageLoadingCheck
        style="
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto;
          height: 100%;
        "
      />
    </ion-content>
    <ion-footer>
      <ion-grid>
        <ion-row>
          <ion-col size="3">
            <custom-button
              @click="eyeOn"
              size="large"
              expand="block"
              :fill="bookmarkYn === 'Y' ? 'solid' : 'outline'"
              :color="bookmarkYn === 'Y' ? 'primary' : 'secondary'"
              :disabled="!bookmarkCheckDisabled"
            >
              <ion-icon
                :icon="heartOutline"
                size="large"
                color="light"
              ></ion-icon>
            </custom-button>
          </ion-col>
          <ion-col size="9">
            <custom-button
              v-if="ssUserYn === 'Y'"
              @click="joinIn"
              size="large"
              expand="block"
              color="primary"
              :disabled="!joinInCheckDisabled"
            >
              ëŒ€í™”í•˜ê¸°
            </custom-button>
            <custom-button
              v-else-if="attendChk === 'ATTEND'"
              @click="joinIn"
              size="large"
              expand="block"
              color="primary"
              :disabled="!joinInCheckDisabled"
            >
              ëŒ€í™”í•˜ê¸°
            </custom-button>
            <custom-button
              class="footerBtn1"
              v-else-if="
                inviteYn === 'Y' &&
                attendRegTime !== '' &&
                attendChk === 'NOTATTEND' &&
                attendYn !== 'N'
              "
              @click="joinIn"
              size="large"
              expand="block"
              color="danger"
              :disabled="!joinInCheckDisabled"
            >
              ì·¨ì†Œí• ë˜ìš”
            </custom-button>
            <custom-button
              v-else
              @click="joinIn"
              size="large"
              expand="block"
              color="secondary"
              :disabled="!joinInCheckDisabled"
            >
              ì°¸ì—¬í•˜ê¸°
            </custom-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-footer>
  </ion-page>
</template>

<script>
import {
  starOutline,
  ellipsisVertical,
  heartOutline,
  flameOutline,
  locationOutline
} from "ionicons/icons";
import {
  getData,
  openChatViewMap,
  openChatWriteMapFn,
  openChatViewMapFn,
  policeMapFn,
  dailyCardInfoMapFn,
  messageTalkMapFn
} from "@/assets/js/common";
// import { loadingController } from "@ionic/vue";
import OpenChatViewUserInfo from "@/components/OpenChatView/OpenChatViewUserInfo.vue";
import OpenChatPrivate from "@/components/OpenChat/OpenChatPrivate.vue";
import CustomBoostModal from "@/components/Custom/CustomBoostModal.vue";
import IconCalCheck from "@/assets/img/icon/icon_cal_check.svg";
import PageLoadingCheck from "@/components/PageLoadingCheck.vue";
import IconMenu from "@/assets/img/icon/icon_menu.svg";
import OpenChatViewAttendList from "@/components/OpenChatView/OpenChatViewAttendList.vue";
import OpenChatViewAttendItem from "@/components/OpenChatView/OpenChatViewAttendItem.vue";

export default {
  name: "OpenChatView",
  inject: ["alertController", "loadingController"],
  components: {
    OpenChatPrivate,
    OpenChatViewUserInfo,
    PageLoadingCheck,
    CustomBoostModal,
    OpenChatViewAttendItem,
    OpenChatViewAttendList
  },
  ionViewWillEnter() {
    //ì´ˆê¸°í™”
    this.openChatLodingCheck = false;
    if (this.$route.params.routerType === "doRefresh") {
      this.beforeReset();
    }
    //ì¡°íšŒ
    this.getOpenChatDetail();
    // this.getAttendInfo();
  },
  ionViewDidLeave() {
    // ì´ˆê¸°í™”
    clearInterval(this.interval);
    clearInterval(this.interval2);

    this.isLeader = false;
    this.attendInfoList = [];
  },
  data() {
    return {
      menuIcon: IconMenu,
      locationOutline,
      calendarIcon: IconCalCheck,
      starOutline,
      ellipsisVertical,
      heartOutline,
      flameOutline,

      chatDetailMap: {},
      bookmarkYn: "",
      msg: "",
      regDate: "",
      dueDate: "",
      inviteYn: "",
      ssUserYn: "",
      mainFileId: "",
      isPopover: false,
      regUserKey: "",
      userPhotoId: "",
      attendYn: "",
      chatroomId: "",
      loading: null,
      attendChk: "",
      leaderConfirmYn: "",
      attendRegTime: "",
      recentTime: "",

      coupon: "",
      useType: "",
      boostModal: false,
      isBuffYn: "N",
      remainingTime: "",
      remainingTimeStr: "",
      interval: null,
      interval2: null,
      calTimeStr: "00:00:00",
      openchatRank: "",
      totalRoom: "",
      useCnt: "0",
      itemList: "",
      cdnNm: "",
      cdnThumbNm: "",
      cdnThumbNmProfile: "",
      lodingCheck: false,
      openChatLodingCheck: false,
      attendInfoList: [],
      bookmarkCheckDisabled: true, // ë¶ë§ˆí¬ í™œì„±í™”ì—¬ë¶€ ì²´í¬
      joinInCheckDisabled: true, // ì°¸ì—¬ë²„íŠ¼ í™œì„±í™”ì—¬ë¶€ ì²´í¬
      loadingTime: 500, // ë²„íŠ¼ ë¡œë”©ì§€ì—°
      privateYn: true,
      isLeader: false

    };
  },

  methods: {
    /** ì˜¤í”ˆì±— ìµœê·¼ í™œë™ ë©˜íŠ¸ format í•¨ìˆ˜ **/
    getRecentDate(args) {
      const today = new Date();
      const timeValue = new Date(args);

      const betweenTime = Math.floor((today.getTime() - timeValue.getTime()) / 1000 / 60);
      if (betweenTime < 1) return "ë°©ê¸ˆ ì „";
      if (betweenTime < 60) {
        return `${betweenTime}ë¶„ ì „`;
      }

      const betweenTimeHour = Math.floor(betweenTime / 60);
      if (betweenTimeHour < 24) {
        return `${betweenTimeHour}ì‹œê°„ ì „`;
      }

      const betweenTimeDay = Math.floor(betweenTime / 60 / 24);
      if (betweenTimeDay < 365) {
        return `${betweenTimeDay}ì¼ ì „`;
      }

      return `${Math.floor(betweenTimeDay / 365)}ë…„ ì „`;
    },

    dismiss() {
      this.$refs.modal.$el.dismiss();
    },
    beforeReset() {
      this.chatDetailMap = {};
      this.userPhotoId = "";
      this.mainFileId = "";

      clearInterval(this.interval);
      clearInterval(this.interval2);
      this.isBuffYn = "N";
      this.remainingTime = "";
      this.remainingTimeStr = "";
      this.calTimeStr = "00:00:00";
      this.openchatRank = "";
      this.totalRoom = "";
      this.useCnt = "0";
    },
    setCheckPrivateYn() {
      this.showLoading();
      getData({
        url: "/setCheckPrivateYn",
        param: {
          openChatKey: openChatViewMap.openChatKey,
          privateYn: this.privateYn
        },
        then: (data) => {
          if (data.successYn === "N") {
            this.getOpenChatDetail();
            this.warningAlert(data.message);
          } else {
            this.privateYn = data.privateYn == "Y" ? true : false;
          }
          setTimeout(() => {
            this.loading.dismiss();
          }, 500);
        }
      });
    },

    getOpenChatDetail() {
      //ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ì— ë‚´ê°€ ë³¸ ê²Œì‹œê¸€ì„ ì €ì¥í•˜ê³  ì²˜ìŒë³´ëŠ”ê±°ë©´ ì¡°íšŒìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¨ë‹¤.
      //viewList = [{articleId: 1}, {articleId:2}]

      let isExist = false;
      let viewList = sessionStorage.getItem("articleViewList");
      let time = new Date();
      let currTime = new Date();

      if (!viewList) {
        viewList = [];
      } else {
        viewList = JSON.parse(viewList);
      }

      for (let idx in viewList) {
        if (viewList[idx]["openChatKey"] === openChatViewMap.openChatKey) {
          //ì´ë¯¸ìˆìŒ
          isExist = true;
        }

        //í•˜ë£¨ê°€ ê²½ê³¼í–ˆìœ¼ë©´ ì‚­ì œí•œë‹¤.
        let diffTime =
          (currTime.getTime() - new Date(viewList[idx]["time"]).getTime()) /
          (60 * 1000);
        if (diffTime > 1440) {
          viewList.splice(idx, 1);
        }
      }

      //ì—†ìœ¼ë©´ ì¡°íšŒì´ë ¥ì„ ì¶”ê°€í•œë‹¤.
      if (!isExist) {
        viewList.push({ openChatKey: openChatViewMap.openChatKey, time: time });
        sessionStorage.setItem("articleViewList", JSON.stringify(viewList));
      }

      getData({
        url: "/getOpenChatDetail",
        param: {
          openChatKey: openChatViewMap.openChatKey,
          viewAddYn: isExist ? "Y" : "N"
        },
        then: (data) => {

          this.itemList = data;
          this.regDate = data.regDateStr;
          this.dueDate = data.dueDateStr;

          this.inviteYn = data.attenderCancelYn === "N" ? "Y" : "N";
          this.bookmarkYn = data.bookmarkYn;
          this.chatDetailMap = data;
          this.ssUserYn = data.ssUserKey === data.regUserKey ? "Y" : "N";
          this.regUserKey = data.regUserKey;
          this.mainFileId = data.mainFileId;
          this.attendYn = data.attendYn;
          this.chatroomId = data.chatroomId;

          this.attendChk = data.attendChk;
          this.leaderConfirmYn = data.leaderConfirmYn;
          this.attendRegTime = data.attendRegTime;

          this.openchatRank = data.openchatRank;
          this.totalRoom = data.totalRoom;
          this.useCnt = data.useCnt;
          this.cdnNm = data.cdnNm;
          this.cdnThumbNm = data.cdnThumbNm;
          this.privateYn = data.privateYn == "Y" ? true : false;
          this.recentTime = this.getRecentDate(data.recentTime);

          this.$nextTick(() => {
            this.getUserInfo();
            if (data.regUserKey == data.ssUserKey) {
              this.isLeader = true;
              this.getAttendInfo();
            }

            this.replaceURL();
          });
        }
      });
    },

    replaceURL() {
      let regexp = /(?:http(s?)?|www)\S+\w/g;
      let _match = this.chatDetailMap.content.match(regexp);
      let match = [...new Set(_match)];
      this.chatDetailMap.replaceContent = this.chatDetailMap.content;
      Array.from(match).forEach((item) => {
        if (!item.includes("http")) {
          this.chatDetailMap.replaceContent = this.chatDetailMap.replaceContent.replaceAll(item, `<a href="http://${item}" target="_blank">${item}</a>`);
        } else {
          this.chatDetailMap.replaceContent = this.chatDetailMap.replaceContent.replaceAll(item, `<a href="${item}" target="_blank">${item}</a>`);
        }
      });
    },

    getAttendInfo() {
      getData({
        url: "/getAttendInfo",
        param: {
          openChatKey: openChatViewMap.openChatKey
        },
        then: (data) => {
          this.attendInfoList = data;

          this.$nextTick(() => {
            this.getUserInfo();
          });
        }
      });
    },
    agreeYn(type, userKey) {

      this.showLoading();
      /** ìˆ˜ë½/ê±°ì ˆ ì´ë²¤íŠ¸
       * paramìœ¼ë¡œ ì°¸ì—¬ì‹ ì²­ìID, ì˜¤í”ˆì±—ID, íƒ€ì… **/
      getData({
        url: "/updateOpenChatAttendYn",
        param: {
          openChatKey: openChatViewMap.openChatKey,
          userKey: userKey,
          type: type,
          fileId: 0
        },
        then: (data) => {
          if (data.successYn === "Y") {
            if (data.confirmYn === "Y") {
              this.warningAlert("ìˆ˜ë½ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤");
            } else {
              this.warningAlert("ê±°ì ˆ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤");
            }
          } else {
            this.warningAlert(data.message);
          }
          this.loading.dismiss();
          this.$nextTick(() => {
            this.getAttendInfo();
          });
        }
      });
    },
    getUserInfo() {
      alert;
      getData({
        url: "/getUserInfo",
        param: {
          regUserKey: this.regUserKey
        },
        then: (data) => {
          this.userPhotoId = data.userPhotoId;
          this.cdnThumbNmProfile = data.cdnThumbNm;

          this.openChatLodingCheck = true;

          this.$nextTick(() => {
            this.getUserCouponDataOne();
          });
        }
      });
    },
    prevPage() {
      this.beforeReset();
      // ì˜¤í”ˆì±—ë·°ë¡œ ê°€ê¸° ì§ì „ ë©”ë‰´ ì²´í¬
      if (openChatViewMap.type === "openChat") {
        this.$router.push("/openChat");
      } else if (openChatViewMap.type === "myOpenChat") {
        this.$router.push("/myOpenChat");
      } else if (openChatViewMap.type === "home") {
        this.$router.push("/home");
      } else if (openChatViewMap.type === "openChatMap") {
        openChatViewMapFn({
          type: "openChatView",
          modal: "open",
          item: openChatViewMap.mpaInfo
        });
        this.$router.push("/openChatMap");
      } else {
        // this.$router.push("/openChat");
        this.$router.go(-1);
      }
    },

    eyeOn() {
      this.showLoading();
      this.bookmarkCheckDisabled = false;
      getData({
        url: "/setOpenChatBookmark",
        param: {
          openChatKey: openChatViewMap.openChatKey
        },
        then: (data) => {
          this.bookmarkYn = data.bookmarkYn;
          this.msg = data.message;

          setTimeout(() => {
            this.loading.dismiss();
            this.bookmarkCheckDisabled = true;
          }, this.loadingTime);
        }
      });
    },

    joinIn() {
      if (this.attendYn === "Y" || this.ssUserYn === "Y") {
        messageTalkMapFn({ chatroomId: this.chatroomId, type: "openChat" });
        this.$router.push("/messageTalk");
      } else {
        this.showLoading();
        this.joinInCheckDisabled = false;
        getData({
          url: "/setOpenChatInvite",
          param: {
            openChatKey: openChatViewMap.openChatKey
          },
          then: (data) => {
            this.inviteYn = data.inviteYn;

            setTimeout(() => {
              this.loading.dismiss();
              this.joinInCheckDisabled = true;
            }, this.loadingTime);
          }
        });
      }
    },
    profileInfo(userKey) {
      dailyCardInfoMapFn({ userKey: userKey, type: "openChatView" });
      this.$router.push("/dailyCardInfo");
    },
    editOpenChat(item) {
      openChatWriteMapFn({
        openChatKey: openChatViewMap.openChatKey,
        type: "edit",
        item: item
      });
      this.$router.push("/openChatWrite");
    },
    async presentAlertConfirm() {
      const alert = await this.alertController.create({
        //cssClass: 'my-custom-class',
        header: "",
        message: "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        buttons: [
          {
            text: "ì·¨ì†Œ",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
            }
          },
          {
            text: "ì‚­ì œ",
            handler: () => {
              getData({
                url: "/setOpenChatDel",
                param: {
                  openChatKey: openChatViewMap.openChatKey
                },
                then: () => {
                }
              });

              this.presentAlert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");

              this.$router.go(-1);
            }
          }
        ]
      });
      return alert.present();
    },
    policeBtn() {
      let regUserKey = this.chatDetailMap.regUserKey;
      policeMapFn({
        targetId: regUserKey,
        type: "openChatView",
        targetKey: openChatViewMap.openChatKey
      });
      this.$router.push("/police");
    },
    // ì•Œë¦¼ì°½
    async presentAlert(msg) {
      const alert = await this.alertController.create({
        header: "",
        message: msg,
        buttons: [
          {
            text: "OK",
            role: "Okay",
            handler: () => {
            }
          }
        ]
      });
      return alert.present();
    },
    /** ë³´ìœ í˜„í™© **/
    getUserCouponDataOne() {
      let couponCd = "CU008";
      getData({
        url: "/getUserCouponDataOne",
        param: { couponCd: couponCd },
        then: (data) => {
          this.coupon = data;

          if (this.coupon.quantity > 0) {
            this.useType = "COUPON";
          } else {
            this.useType = "HEART";
          }
        }
      });
    },
    openUseOpenChatModal() {
      this.getBuffUsingInfo();
      this.getUserCouponDataOne();
      clearInterval(this.interval2);
      this.interval2 = setInterval(() => {
        this.getBuffUsingInfo();
        this.getUserCouponDataOne();
      }, 10000);
      this.boostModal = true;
    },
    boostModalClose() {
      clearInterval(this.interval2);
      this.boostModal = false;
    },
    /** useOpenChatBoost ì‚¬ìš© ë¡œì§ **/
    useOpenChatBoost() {
      let msg = "ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
      if (this.coupon.quantity === 0) {
        this.boostModal = false;
        this.$router.push("/store");
      } else {
        const useOpenChatBoost = () => {
          getData({
            url: "/useOpenChatBoost",
            param: {
              couponCd: "CU008",
              useType: this.useType, // 'COUPON', 'HEART'
              itemCd: this.useType === "HEART" ? "IT008_01" : "", // useType
              pointCd: this.useType === "HEART" ? "BUY" : "", // useType
              openChatKey: openChatViewMap.openChatKey
            },
            then: (data) => {
              if (
                data.successYn === "N" ||
                data.successYn === "NH" ||
                data.successYn === "NE"
              ) {
                this.warningAlertNH(data.message);
              } else {
                this.warningAlert(data.message);

                this.getBuffUsingInfo();
                this.getUserCouponDataOne();

                clearInterval(this.interval2);
                this.interval2 = setInterval(() => {
                  this.getBuffUsingInfo();
                  this.getUserCouponDataOne();
                }, 10000);
              }
            }
          });
        };
        this.warningConfirm(msg, useOpenChatBoost);
      }
    },
    getBuffUsingInfo() {
      getData({
        url: "/getBuffUsingInfo",
        param: {
          couponCd: "CU008",
          openChatKey: openChatViewMap.openChatKey
        },
        then: (data) => {
          this.isBuffYn = data.isBuffYn;
          this.remainingTime = data.remainingTime;
          this.remainingTimeStr = data.remainingTimeStr;
          this.useCnt = data.useCnt;
          this.openchatRank = data.openchatRank;
          this.totalRoom = data.totalRoom;

          this.$nextTick(() => {
            clearInterval(this.interval);
            this.timeCal();
            this.interval = setInterval(() => {
              if (this.isBuffYn === "Y") {
                this.timeCal();
              }
            }, 1000);
          });
        }
      });
    },
    timeCal() {
      let hour, min, sec;

      hour = parseInt(this.remainingTime / 3600);
      min = parseInt((this.remainingTime % 3600) / 60);
      sec = this.remainingTime % 60;

      if (hour.toString().length === 1) hour = "0" + hour;
      if (min.toString().length === 1) min = "0" + min;
      if (sec.toString().length === 1) sec = "0" + sec;

      if (this.remainingTime > 0) {
        this.remainingTime = this.remainingTime - 1;
      } else {
        this.remainingTime = 0;
        clearInterval(this.interval);
        this.isBuffYn = "N";
      }
      this.calTimeStr = hour + ":" + min + ":" + sec;
    },

    /** ê²½ê³  íŒì—…ì°½ **/
    async warningAlert(message) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: ["OK"]
      });
      return alert.present();
    },

    async warningConfirm(message, callback) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: [
          {
            text: "ì•„ë‹ˆìš”",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
            }
          },
          {
            text: "ë„¤",
            handler: () => {
              callback();
            }
          }
        ]
      });
      return alert.present();
    },

    async warningAlertNH(message) {
      const alert = await this.alertController.create({
        header: "",
        subHeader: "",
        message: message,
        buttons: [
          {
            text: "ì·¨ì†Œ",
            role: "cancel",
            cssClass: "secondary",
            handler: () => {
            }
          },
          {
            text: "ì´ë™",
            handler: () => {
              this.$router.push("/store");
              this.boostModal = false;
            }
          }
        ]
      });
      return alert.present();
    },

    /** ë¡œë”© **/
    async showLoading() {
      this.loading = await this.loadingController.create({
        message: "Loading...",
        duration: 0
      });
      await this.loading.present();
    }
  }
};
</script>

<style scoped></style>
